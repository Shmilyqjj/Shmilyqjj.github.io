<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- è¿™ä¸ªheadä¸­çš„å±æ€§ä¼šå½±å“å…¨å±€çš„ï¼Œæ¯”å¦‚å…¨å±€å˜è‰²å¯ä»¥åœ¨è¿™ä¿®æ”¹ï¼Œä¸‹é¢æ˜¯ä¾‹å­ï¼š -->
  <style type="text/css"> html {FILTER: grayscale(0)}</style>   <!-- 2020.4.4æ–°å† ç—…æ¯’é»˜å“€æ—¥ è°ƒèŠ‚ç½‘é¡µä¸ºç°è‰²  ç°åº¦è®¾ç½® ç™¾åˆ†æ¯” 0-100  -->
  <meta charset="utf-8">
  <!-- baiduç«™é•¿å·¥å…·è®¤è¯ -->
  <meta name="baidu-site-verification" content="code-DIsXeN91UI" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ | ä½³å¢ƒçš„å°æœ¬æœ¬</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * é‚®ç®±ä¿¡æ¯ä¹‹ç±»çš„ä¸œè¥¿å¯ä»¥å¡«åœ¨è¿™é‡Œï¼Œè¿™äº›jså˜é‡åŸºæœ¬éƒ½ä½œç”¨äºsakura-app.js
   * è¿™æ ·çš„è®¾ç½®ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨åŸºäºPHPå¼€å‘çš„ä¸»é¢˜ä¸­è®¾ç½®jså˜é‡ï¼Œæ—¢ç„¶ç§»æ¤åˆ°äº†Nodeä¸Šï¼Œæˆ‘æƒ³æˆ–è®¸å¯ä»¥ç²¾ç®€è¿™ä¸€é€»è¾‘å§
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "ä½³å¢ƒShmily";
  mashiro_option.author_name = "Shmily";
  mashiro_option.site_url = "shmily-qjj.top";
  mashiro_option.v_appId = "zUyVEaHo59RUUwiPTChPEeBj-gzGzoHsz";
  mashiro_option.v_appKey = "xIEyTcrkTuJLz6ewPbpTj8mz";
  mashiro_option.mathjax = "0";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(0).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(9).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(10).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(11).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(18).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(21).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(22).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(23).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(26).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(27).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(28).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(29).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(30).webp,https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/cover/(31).webp".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('æœ‹å‹ï¼ŒIEæµè§ˆå™¨æœªé€‚é…å“¦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
<meta name="generator" content="Hexo 5.1.1"></head>

<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="shmily-qjj.top">
          <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/custom/avatar.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>è®°å¾—æ¯å¤©è¦æ—©ç¡å‘€ï¼</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/Shmilyqjj" target="_blank" class="social-github" title="github">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/github.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://music.163.com/artist?id=13610347&amp;userid=318926152" target="_blank" class="social-github" title="CloudMusic">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/wangyiyun.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://space.bilibili.com/55921513" target="_blank" class="social-github" title="bilibili">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/bilibili.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="mailto:710552907@qq.com?subject=test&amp;cc=sample@hotmail.com&amp;body=use mailto sample" target="_blank" class="social-github" title="email">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/email.svg">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=710552907&amp;site=qq&amp;menu=yes" target="_blank" class="social-github" title="qq">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/qq.png">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/social/wechat.png">
                  </a>
                  <div class="wechatInner">
                    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/custom/WeChat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">ä½³å¢ƒ</span>
            <span class="shironeko">Shmily</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    é¦–é¡µ
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    å½’æ¡£
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          æŠ€æœ¯
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E7%94%9F%E6%B4%BB/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          ç”Ÿæ´»
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E9%9F%B3%E4%B9%90/">
                          <i class="fa fa-music" aria-hidden="true"></i>
                          éŸ³ä¹
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E9%9A%8F%E6%83%B3/">
                          <i class="fa fa-commenting-o" aria-hidden="true"></i>
                          éšæƒ³
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E5%85%B6%E4%BB%96/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          å…¶ä»–
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    æ¸…å•
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          çœ‹å‰§
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          ä¹¦å•
                        </a>
                      </li>
                    
                      <li>
                        <a href="/music/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          æ­Œå•
                        </a>
                      </li>
                    
                      <li>
                        <a href="/album/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          ç›¸å†Œ
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
                    ç•™è¨€æ¿
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
                    åšå‹åœˆ
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/donate/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
                    èµèµ
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    å…³äº
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          æˆ‘ï¼Ÿ
                        </a>
                      </li>
                    
                      <li>
                        <a target="_blank" rel="noopener" href="https://tech.shmily-qjj.top/">
                          <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                          æŠ€æœ¯
                        </a>
                      </li>
                    
                      <li>
                        <a href="/lab/">
                          <i class="fa fa-cogs" aria-hidden="true"></i>
                          Lab
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/client/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
                    å®¢æˆ·ç«¯
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/atom.xml">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
                    RSS
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

<!-- å±è”½F12æŸ¥çœ‹æ–‡ç« å†…å®¹+é¿å…å›¾ç‰‡è¢«æ‹–æ‹½ä¿å­˜ -->

  <script language="Javascript">
    document.onkeydown=function (e){
      var currKey=0,evt=e||window.event;
      currKey=evt.keyCode||evt.which||evt.charCode;
      if (currKey >111 && currKey < 124) {
        window.event.cancelBubble = true;
        window.event.returnValue = false;
      }
    }
    for (i in document.images) document.images[i].ondragstart = imgdragstart;
    function imgdragstart() {
      return false;
    }
  </script>


<!-- å®ç°æ–‡ç« çš„notshowå’Œnocopyå±æ€§ï¼Œæ”¯æŒæ¨¡ç³Šã€å±è”½æ–‡ç« å†…å®¹ï¼Œç¦æ­¢å¤åˆ¶åŠŸèƒ½ -->

  <!-- å¯¹äºæœªæŒ‡å®šnotshowå±æ€§æˆ–æœªæŒ‡å®šnocopyå±æ€§çš„ æˆ–ä¸ºfalseçš„ï¼Œæ¢å¤å¯å¤åˆ¶å¯é€‰æ‹©æƒé™ -->
  <script language="Javascript">
    document.oncontextmenu="";
    document.onselectstart=true;
  </script>
  


  <div class="pattern-center single-center">
    <!-- æœ‰é…å›¾é»˜è®¤æ¸²æŸ“ç¬¬ä¸€å¼  -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/DataLake/Iceberg/Iceberg-cover.jpg);" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/DataLake/Iceberg/Iceberg-cover.jpg">
    </div>
    <header class="pattern-header single-header">
      <h1 class="entry-title">
      Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ</h1>
      <p class="entry-census">
        <span>
          <a href="shmily-qjj.top">
            <img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/custom/avatar.jpg">
          </a>
        </span>
        <span>
          <a href="shmily-qjj.top">ä½³å¢ƒ</a>
        </span>
        <span class="bull">
        Â·</span>
        2022-10-31<span class="bull">
        Â·</span>
      <span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»</p>
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- å¥—åµŒç›®å½•ä½¿ç”¨ï¼ˆä¸»è¦ä¸ºäº†æ”¯æ´è¯„è®ºï¼‰-->
        
        <div class="entry-content">
          <h1 id="Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ"><a href="#Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ" class="headerlink" title="Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ"></a>Icebergæ•°æ®æ¹–æ¢ç´¢ä¸å®è·µ</h1><h2 id="æ¦‚å¿µå¼•å…¥â€“æ•°æ®æ¹–"><a href="#æ¦‚å¿µå¼•å…¥â€“æ•°æ®æ¹–" class="headerlink" title="æ¦‚å¿µå¼•å…¥â€“æ•°æ®æ¹–"></a>æ¦‚å¿µå¼•å…¥â€“æ•°æ®æ¹–</h2><ul>
<li><strong>æ•°æ®æ¹–æ˜¯ä¸€ç§å­˜å‚¨æ•°æ®çš„æ–¹å¼</strong>,ç”¨äºç»„ç»‡ä¸åŒæ•°æ®ç»“æ„.æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ä¼ä¸šæ•°æ®æ¶æ„æ–¹æ³•,ç‰©ç†å®ç°ä¸Šåˆ™æ˜¯åŸºäºæ•°æ®å­˜å‚¨å¹³å°(ä¾‹å¦‚Hadoop,OSS,S3ç­‰å­˜å‚¨ç³»ç»Ÿ),<strong>é›†ä¸­å­˜å‚¨ä¼ä¸šå†…æµ·é‡çš„ã€å¤šæ¥æº,å¤šç§ç±»çš„æ•°æ®,å¹¶æ”¯æŒå¯¹æ•°æ®è¿›è¡Œå¿«é€ŸåŠ å·¥å’Œåˆ†æ</strong>.</li>
<li><strong>æ•°æ®æ¹–çš„ä¸»è¦æ€æƒ³æ˜¯å¯¹ä¼ä¸šä¸­çš„æ‰€æœ‰æ•°æ®è¿›è¡Œç»Ÿä¸€å­˜å‚¨</strong>,ä»åŸå§‹æ•°æ®è½¬æ¢ä¸ºç”¨äºæŠ¥å‘Šã€å¯è§†åŒ–ã€åˆ†æå’Œæœºå™¨å­¦ä¹ ç­‰å„ç§ä»»åŠ¡çš„ç›®æ ‡æ•°æ®.</li>
<li>æ•°æ®æ¹–ä¸­çš„æ•°æ®åŒ…æ‹¬ç»“æ„åŒ–æ•°æ®ï¼ˆå…³ç³»æ•°æ®åº“æ•°æ®ï¼‰,åŠç»“æ„åŒ–æ•°æ®ï¼ˆCSVã€XMLã€JSONç­‰ï¼‰,éç»“æ„åŒ–æ•°æ®ï¼ˆç”µå­é‚®ä»¶,æ–‡æ¡£,PDFï¼‰å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼ˆå›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ï¼‰,ä»è€Œå½¢æˆä¸€ä¸ªå®¹çº³æ‰€æœ‰å½¢å¼æ•°æ®çš„é›†ä¸­å¼æ•°æ®å­˜å‚¨.</li>
</ul>
<h2 id="Icebergç®€ä»‹"><a href="#Icebergç®€ä»‹" class="headerlink" title="Icebergç®€ä»‹"></a>Icebergç®€ä»‹</h2><p><strong>Icebergæ˜¯ä¸€ç§é«˜æ€§èƒ½çš„TableFormat(è¡¨æ ¼å¼),å®šä¹‰äº†æ•°æ®ã€å…ƒæ•°æ®çš„ç»„ç»‡æ–¹å¼,æ”¯æŒåœ¨Sparkã€Trinoã€Flinkã€HiveåŠImpalaç­‰è®¡ç®—å¼•æ“ä¸­ä½¿ç”¨.</strong></p>
<h3 id="Icebergç‰¹æ€§"><a href="#Icebergç‰¹æ€§" class="headerlink" title="Icebergç‰¹æ€§"></a>Icebergç‰¹æ€§</h3><ol>
<li>çœŸæ­£çš„æµæ‰¹ä¸€ä½“: ä¸Šæ¸¸å†™å…¥æ•°æ®åä¸‹æ¸¸ç«‹å³å¯æŸ¥,æ»¡è¶³å®æ—¶åœºæ™¯;Icebergæä¾›äº†æµæ‰¹è¯»å–å’Œæµæ‰¹å†™å…¥æ¥å£,ç”¨æˆ·å¯ä»¥åœ¨åŒä¸€ä¸ªæµç¨‹åŒæ—¶å¤„ç†æµæ‰¹æ•°æ®,ä½¿å¾—æµæ‰¹å¤„ç†å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨æ¨¡å‹,ç®€åŒ–äº†ETLæ€è·¯.</li>
<li>æ”¯æŒå¼‚æ„è®¡ç®—å’Œå­˜å‚¨å¼•æ“: å­˜å‚¨ä¸Šæ”¯æŒå¸¸è§å­˜å‚¨å¦‚HDFSä»¥åŠå„ç§å¯¹è±¡å­˜å‚¨(ä¸ä¸åº•å±‚å­˜å‚¨å¼ºç»‘å®š);è®¡ç®—ä¸Šæ”¯æŒFlink,Spark,Presto,Hiveç­‰å¸¸è§è®¡ç®—å¼•æ“.</li>
<li>Schema Evolution(æ¨¡å¼æ¼”åŒ–): æ”¯æŒæ— å‰¯ä½œç”¨åœ°å¢(ADD)åˆ (Drop)æ”¹(Update)åˆ—,æ”¹å˜åˆ—é¡ºåº(Reorder)ä»¥åŠé‡å‘½ååˆ—(Rename),ä¸”ä»£ä»·å¾ˆä½(åªæ¶‰åŠå…ƒæ•°æ®æ“ä½œ,ä¸å­˜åœ¨æ•°æ®é‡æ–°è¯»å†™æ“ä½œ)(Icebergä½¿ç”¨å”¯ä¸€IDå®šä½åˆ—,æ–°å¢åˆ—ä¼šåˆ†é…æ–°çš„ID,æ‰€ä»¥åˆ—ä¸ä¼šé”™ä½)</li>
<li>Partition Evolution(åˆ†åŒºæ¼”åŒ–): åœ¨å·²æœ‰çš„è¡¨ä¸Šæ”¹å˜åˆ†åŒºç­–ç•¥æ—¶,ä¹‹å‰çš„åˆ†åŒºæ•°æ®ä¸ä¼šå˜ä¸”ä¾ç„¶é‡‡ç”¨è€çš„åˆ†åŒºç­–ç•¥,æ–°æ•°æ®ä¼šé‡‡ç”¨æ–°çš„åˆ†åŒºç­–ç•¥.åœ¨Icebergå…ƒæ•°æ®é‡Œ,ä¸¤ä¸ªåˆ†åŒºç­–ç•¥ç›¸äº’ç‹¬ç«‹.æ¯”å¦‚ä»¥å‰æœ‰ä¸ªå¤©åˆ†åŒºè¡¨,ç°åœ¨ä¸šåŠ¡éœ€è¦å°æ—¶åˆ†åŒº,æŒ‰Hiveæ•°ä»“çš„å¤„ç†æ–¹å¼éœ€è¦é‡æ–°å»ºè¡¨,ä½†Icebergè¡¨ç›´æ¥åœ¨åŸè¡¨ä¸Šæ›´æ”¹åˆ†åŒºå¸ƒå±€å³å¯.<br><img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/DataLake/Iceberg/Iceberg-1.png" alt="alt"></li>
<li>æ”¯æŒéšè—åˆ†åŒº: Icebergçš„åˆ†åŒºä¿¡æ¯ä¸éœ€è¦äººå·¥ç»´æŠ¤,å¯ä»¥è¢«éšè—èµ·æ¥.ä¸HiveæŒ‡å®šåˆ†åŒºå­—æ®µçš„æ–¹å¼ä¸åŒ,Icebergçš„åˆ†åŒºå­—æ®µ(åˆ†åŒºç­–ç•¥)æ”¯æŒé€šè¿‡æŸå­—æ®µè®¡ç®—å‡ºæ¥,åœ¨å»ºè¡¨æˆ–è€…ä¿®æ”¹åˆ†åŒºç­–ç•¥ä¹‹å, æ–°çš„æ•°æ®ä¼šè‡ªåŠ¨è®¡ç®—æ‰€å±äºçš„åˆ†åŒº,æŸ¥è¯¢æ—¶Icebergä¼šè‡ªåŠ¨è¿‡æ»¤ä¸éœ€è¦æ‰«æçš„æ•°æ®,é¿å…äº†å› ç”¨æˆ·SQLæœªæŒ‡å®šåˆ†åŒºè¿‡æ»¤æ¡ä»¶è€Œå¯¼è‡´çš„æ€§èƒ½é—®é¢˜,è®©ç”¨æˆ·æ›´ä¸“æ³¨ä¸šåŠ¡é€»è¾‘è€Œæ— éœ€è€ƒè™‘åˆ†åŒºå­—æ®µè¿‡æ»¤é—®é¢˜.(Icebergåˆ†åŒºä¿¡æ¯å’Œæ•°æ®å­˜å‚¨ç›®å½•æ˜¯ç›¸äº’ç‹¬ç«‹å¼€çš„,ä½¿å¾—Icebergè¡¨åˆ†åŒºå¯ä»¥è¢«ä¿®æ”¹,è€Œä¸”ä¸æ¶‰åŠæ•°æ®è¿ç§»;åˆ†åŒºä¿¡æ¯ä¸å­˜åœ¨HMS,å‡è½»äº†HMSçš„å‹åŠ›)</li>
<li>åˆ†åŒºæ¼”åŒ–å’Œéšè—åˆ†åŒºä½¿å¾—ä¸šåŠ¡å¯ä»¥æ–¹ä¾¿åœ°è°ƒæ•´åˆ†åŒºç­–ç•¥.</li>
<li>Time Travel: å¯ä»¥æŸ¥è¯¢å†å²æŸä¸€æ—¶é—´ç‚¹snapshotçš„æ•°æ®,æ”¯æŒå›æ»šåˆ°å†å²snapshot.</li>
<li>æ”¯æŒäº‹åŠ¡(ACID): Icebergæä¾›äº†è¾¹è¯»è¾¹å†™çš„èƒ½åŠ›,ä¸Šæ¸¸æ•°æ®å†™å…¥å³å¯è§,é€šè¿‡äº‹åŠ¡,ä¿è¯äº†ä¸‹æ¸¸ç»„ä»¶åªèƒ½æ¶ˆè´¹å·²ç»commitçš„æ•°æ®,æ— æ³•è¯»åˆ°æœªæäº¤çš„æ•°æ®.æ”¯æŒæ·»åŠ åˆ é™¤æ›´æ–°æ•°æ®.</li>
<li>æ”¯æŒåŸºäºä¹è§‚é”çš„å¹¶å‘å†™: IcebergåŸºäºä¹è§‚é”æä¾›äº†å¤šä¸ªç¨‹åºå¹¶å‘å†™å…¥çš„èƒ½åŠ›å¹¶ä¸”ä¿è¯æ•°æ®çº¿æ€§ä¸€è‡´.(ä¹è§‚åˆ›å»ºmetadataæ–‡ä»¶,æäº¤æ›´æ–°ä¼šè§¦å‘metadataåŸå­äº¤æ¢,å®Œæˆæäº¤)</li>
<li>æ–‡ä»¶çº§æ•°æ®å‰ªè£: Icebergé€šè¿‡å…ƒæ•°æ®æ¥å¯¹æŸ¥è¯¢è¿›è¡Œé«˜æ•ˆè¿‡æ»¤,Icebergçš„å…ƒæ•°æ®é‡Œé¢æä¾›äº†æ¯ä¸ªæ•°æ®æ–‡ä»¶çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯, æ¯”å¦‚æœ€å¤§å€¼, æœ€å°å€¼, Countè®¡æ•°ç­‰ç­‰. å› æ­¤, æŸ¥è¯¢SQLçš„è¿‡æ»¤æ¡ä»¶é™¤äº†å¸¸è§„çš„åˆ†åŒº, åˆ—è¿‡æ»¤, ç”šè‡³å¯ä»¥ä¸‹æ¨åˆ°æ–‡ä»¶çº§åˆ«, å¤§å¤§åŠ å¿«äº†æŸ¥è¯¢æ•ˆç‡.</li>
<li>æ”¯æŒå¤šç§åº•å±‚å­˜å‚¨æ ¼å¼å¦‚Parquetã€Avroä»¥åŠORCç­‰.</li>
<li>æ”¯æŒUpsertèƒ½åŠ›,ä¸”æ›´æ–°å³å¯è§,ä½†ä¸èƒ½è¿‡äºé¢‘ç¹,è‹¥Upsertè¿‡äºé¢‘ç¹,åˆ™éœ€è¦é¢‘ç¹æ•°æ®åˆå¹¶</li>
</ol>
<h2 id="IcebergåŸç†"><a href="#IcebergåŸç†" class="headerlink" title="IcebergåŸç†"></a>IcebergåŸç†</h2><h3 id="Icebergå…ƒæ•°æ®"><a href="#Icebergå…ƒæ•°æ®" class="headerlink" title="Icebergå…ƒæ•°æ®"></a>Icebergå…ƒæ•°æ®</h3><p><img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/DataLake/Iceberg/Iceberg-2.png" alt="alt"><br>1.<strong>DataFilesæ•°æ®æ–‡ä»¶</strong> å­˜æ”¾çœŸå®æ•°æ®æ–‡ä»¶,ç”±ä¸€ä¸ªæˆ–å¤šä¸ªManifestFileè·Ÿè¸ª</p>
<p>2.<strong>MetadataFileæ–‡ä»¶</strong> â€œ*.metadata.jsonâ€æ–‡ä»¶,Icebergè¡¨æŸæ—¶åˆ»çš„çŠ¶æ€,é‡Œé¢è®°å½•äº†è¡¨Schema,åˆ†åŒºé…ç½®,è¡¨å‚æ•°,snapshotè®°å½•ä»¥åŠè¿™ä¸ªæ—¶åˆ»æ¶‰åŠåˆ°çš„æ‰€æœ‰çš„ManifestList.</p>
<p>3.<strong>ManifestListæ¸…å•åˆ—è¡¨</strong> â€œsnap-*.avroâ€æ–‡ä»¶,å­˜å‚¨äº†æ„å»ºå¿«ç…§çš„æ‰€æœ‰ManifestFileåˆ—è¡¨,æ¯ä¸ªManifestFileåœ¨é‡Œé¢å ä¸€è¡Œ,æ¯è¡Œå­˜å‚¨äº†ManifestFileè·¯å¾„,åˆ†åŒºèŒƒå›´,å¢åˆ æ–‡ä»¶ä¿¡æ¯,æ¥ä¸ºæŸ¥è¯¢æ—¶æä¾›è¿‡æ»¤èƒ½åŠ›,æé«˜æ€§èƒ½.ä¸€ä¸ªå¿«ç…§å¯¹åº”ä¸€ä¸ªManifestListæ–‡ä»¶.</p>
<p>4.<strong>ManifestFileæ¸…å•æ–‡ä»¶</strong> ésnapå¼€å¤´çš„avroæ ¼å¼æ–‡ä»¶,åŒ…å«äº†DataFilesåˆ—è¡¨,æ¯è¡ŒåŒ…å«ä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„è¯¦ç»†æè¿°(çŠ¶æ€,è·¯å¾„,åˆ†åŒºä¿¡æ¯,åˆ—çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯,æœ€å¤§å€¼æœ€å°å€¼ç©ºå€¼ä¸ªæ•°,æ–‡ä»¶å¤§å°,è¡Œæ•°ç­‰),ä¸ºæŸ¥è¯¢æ—¶æä¾›è¿‡æ»¤èƒ½åŠ›,æé«˜æ€§èƒ½.</p>
<p><strong>HadoopCatalogä¸HiveCatalogè¡¨çš„ç›®å½•ç»“æ„</strong><br><img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/DataLake/Iceberg/Iceberg-3.png" alt="alt"><br>å·®å¼‚:<br>1.HadoopCatalogè¡¨MetadataFileå‘½åä¸º*.metadata.json,ä¸HiveCatalogè¡¨ManifestListå‘½åè§„èŒƒä¸åŒ<br>2.HadoopCatalogè¡¨é€šè¿‡version-hint.textè®°å½•æœ€æ–°å¿«ç…§ID,HiveCatalogé€šè¿‡HiveMetaStoreè®°å½•æœ€æ–°metadata_location.<br>3.HadoopCatalogä¸HiveCatalogè¡¨å…ƒæ•°æ®ä¸äº’é€š,æ— æ³•äº’ç›¸è½¬æ¢</p>
<p><strong>HadoopCatalogè¡¨å…ƒæ•°æ®è§£æ</strong>  </p>
<pre><code class="shell"># æŸ¥çœ‹avroæ–‡ä»¶å†…å®¹
wget https://repo1.maven.org/maven2/org/apache/avro/avro-tools/1.11.1/avro-tools-1.11.1.jar
java -jar avro-tools-1.11.1.jar tojson xxx.avro</code></pre>
<p>MetadataFileæ–‡ä»¶ v3.metadata.json</p>
<pre><code class="json">&#123;
  &quot;format-version&quot; : 1,
  &quot;table-uuid&quot; : &quot;eeffbc08-9156-4a6f-8380-6138c6b67889&quot;,
  &quot;location&quot; : &quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table&quot;,
  &quot;last-updated-ms&quot; : 1667357677633,
  &quot;last-column-id&quot; : 4,
  &quot;schema&quot; : &#123;
    &quot;type&quot; : &quot;struct&quot;,
    &quot;schema-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;id&quot; : 1,
      &quot;name&quot; : &quot;id&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;long&quot;
    &#125;, &#123;
      &quot;id&quot; : 2,
      &quot;name&quot; : &quot;name&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125;, &#123;
      &quot;id&quot; : 3,
      &quot;name&quot; : &quot;age&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;int&quot;
    &#125;, &#123;
      &quot;id&quot; : 4,
      &quot;name&quot; : &quot;dt&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125; ]
  &#125;,
  &quot;current-schema-id&quot; : 0,
  &quot;schemas&quot; : [ &#123;
    &quot;type&quot; : &quot;struct&quot;,
    &quot;schema-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;id&quot; : 1,
      &quot;name&quot; : &quot;id&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;long&quot;
    &#125;, &#123;
      &quot;id&quot; : 2,
      &quot;name&quot; : &quot;name&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125;, &#123;
      &quot;id&quot; : 3,
      &quot;name&quot; : &quot;age&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;int&quot;
    &#125;, &#123;
      &quot;id&quot; : 4,
      &quot;name&quot; : &quot;dt&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125; ]
  &#125; ],
  &quot;partition-spec&quot; : [ &#123;
    &quot;name&quot; : &quot;dt&quot;,
    &quot;transform&quot; : &quot;identity&quot;,
    &quot;source-id&quot; : 4,
    &quot;field-id&quot; : 1000
  &#125; ],
  &quot;default-spec-id&quot; : 0,
  &quot;partition-specs&quot; : [ &#123;
    &quot;spec-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;name&quot; : &quot;dt&quot;,
      &quot;transform&quot; : &quot;identity&quot;,
      &quot;source-id&quot; : 4,
      &quot;field-id&quot; : 1000
    &#125; ]
  &#125; ],
  &quot;last-partition-id&quot; : 1000,
  &quot;default-sort-order-id&quot; : 0,
  &quot;sort-orders&quot; : [ &#123;
    &quot;order-id&quot; : 0,
    &quot;fields&quot; : [ ]
  &#125; ],
  &quot;properties&quot; : &#123;
    &quot;EXTERNAL&quot; : &quot;TRUE&quot;,
    &quot;write.metadata.previous-versions-max&quot; : &quot;5&quot;,
    &quot;bucketing_version&quot; : &quot;2&quot;,
    &quot;write.metadata.delete-after-commit.enabled&quot; : &quot;true&quot;,
    &quot;write.distribution-mode&quot; : &quot;hash&quot;,
    &quot;storage_handler&quot; : &quot;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&quot;
  &#125;,
  &quot;current-snapshot-id&quot; : 1244418053907939374,
  &quot;refs&quot; : &#123;
    &quot;main&quot; : &#123;
      &quot;snapshot-id&quot; : 1244418053907939374,
      &quot;type&quot; : &quot;branch&quot;
    &#125;
  &#125;,
  &quot;snapshots&quot; : [ &#123;
    &quot;snapshot-id&quot; : 7688152750730458585,
    &quot;timestamp-ms&quot; : 1667357628763,
    &quot;summary&quot; : &#123;
      &quot;operation&quot; : &quot;append&quot;,
      &quot;added-data-files&quot; : &quot;1&quot;,
      &quot;added-records&quot; : &quot;2&quot;,
      &quot;added-files-size&quot; : &quot;1272&quot;,
      &quot;changed-partition-count&quot; : &quot;1&quot;,
      &quot;total-records&quot; : &quot;2&quot;,
      &quot;total-files-size&quot; : &quot;1272&quot;,
      &quot;total-data-files&quot; : &quot;1&quot;,
      &quot;total-delete-files&quot; : &quot;0&quot;,
      &quot;total-position-deletes&quot; : &quot;0&quot;,
      &quot;total-equality-deletes&quot; : &quot;0&quot;
    &#125;,
    &quot;manifest-list&quot; : &quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/metadata/snap-7688152750730458585-1-f0e6c6ca-51a7-42e6-b412-4036e27c7d98.avro&quot;,
    &quot;schema-id&quot; : 0
  &#125;, &#123;
    &quot;snapshot-id&quot; : 1244418053907939374,
    &quot;parent-snapshot-id&quot; : 7688152750730458585,
    &quot;timestamp-ms&quot; : 1667357677633,
    &quot;summary&quot; : &#123;
      &quot;operation&quot; : &quot;append&quot;,
      &quot;added-data-files&quot; : &quot;1&quot;,
      &quot;added-records&quot; : &quot;1&quot;,
      &quot;added-files-size&quot; : &quot;1166&quot;,
      &quot;changed-partition-count&quot; : &quot;1&quot;,
      &quot;total-records&quot; : &quot;3&quot;,
      &quot;total-files-size&quot; : &quot;2438&quot;,
      &quot;total-data-files&quot; : &quot;2&quot;,
      &quot;total-delete-files&quot; : &quot;0&quot;,
      &quot;total-position-deletes&quot; : &quot;0&quot;,
      &quot;total-equality-deletes&quot; : &quot;0&quot;
    &#125;,
    &quot;manifest-list&quot; : &quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/metadata/snap-1244418053907939374-1-44671db7-02ca-47c1-a229-c7f62d8aa12f.avro&quot;,
    &quot;schema-id&quot; : 0
  &#125; ],
  &quot;snapshot-log&quot; : [ &#123;
    &quot;timestamp-ms&quot; : 1667357628763,
    &quot;snapshot-id&quot; : 7688152750730458585
  &#125;, &#123;
    &quot;timestamp-ms&quot; : 1667357677633,
    &quot;snapshot-id&quot; : 1244418053907939374
  &#125; ],
  &quot;metadata-log&quot; : [ &#123;
    &quot;timestamp-ms&quot; : 1667357528190,
    &quot;metadata-file&quot; : &quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/metadata/v1.metadata.json&quot;
  &#125;, &#123;
    &quot;timestamp-ms&quot; : 1667357628763,
    &quot;metadata-file&quot; : &quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/metadata/v2.metadata.json&quot;
  &#125; ]
&#125;</code></pre>
<p>ManifestListæ¸…å•åˆ—è¡¨æ–‡ä»¶ snap-7688152750730458585-1-f0e6c6ca-51a7-42e6-b412-4036e27c7d98.avro</p>
<pre><code class="json">&#123;&quot;manifest_path&quot;:&quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/metadata/f0e6c6ca-51a7-42e6-b412-4036e27c7d98-m0.avro&quot;,&quot;manifest_length&quot;:6189,&quot;partition_spec_id&quot;:0,&quot;added_snapshot_id&quot;:&#123;&quot;long&quot;:7688152750730458585&#125;,&quot;added_data_files_count&quot;:&#123;&quot;int&quot;:1&#125;,&quot;existing_data_files_count&quot;:&#123;&quot;int&quot;:0&#125;,&quot;deleted_data_files_count&quot;:&#123;&quot;int&quot;:0&#125;,&quot;partitions&quot;:&#123;&quot;array&quot;:[&#123;&quot;contains_null&quot;:false,&quot;contains_nan&quot;:&#123;&quot;boolean&quot;:false&#125;,&quot;lower_bound&quot;:&#123;&quot;bytes&quot;:&quot;20221011&quot;&#125;,&quot;upper_bound&quot;:&#123;&quot;bytes&quot;:&quot;20221011&quot;&#125;&#125;]&#125;,&quot;added_rows_count&quot;:&#123;&quot;long&quot;:2&#125;,&quot;existing_rows_count&quot;:&#123;&quot;long&quot;:0&#125;,&quot;deleted_rows_count&quot;:&#123;&quot;long&quot;:0&#125;&#125;</code></pre>
<p>ManifestFileæ¸…å•æ–‡ä»¶ f0e6c6ca-51a7-42e6-b412-4036e27c7d98-m0.avro</p>
<pre><code class="json">&#123;&quot;status&quot;:1,&quot;snapshot_id&quot;:&#123;&quot;long&quot;:7688152750730458585&#125;,&quot;data_file&quot;:&#123;&quot;file_path&quot;:&quot;hdfs://shmily:8020/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table/data/dt=20221011/00000-0-hive_20221102105315_5bb17fc0-3092-4bed-8839-253f19117b6d-job_1667357081446_0001-00001.parquet&quot;,&quot;file_format&quot;:&quot;PARQUET&quot;,&quot;partition&quot;:&#123;&quot;dt&quot;:&#123;&quot;string&quot;:&quot;20221011&quot;&#125;&#125;,&quot;record_count&quot;:2,&quot;file_size_in_bytes&quot;:1272,&quot;block_size_in_bytes&quot;:67108864,&quot;column_sizes&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:55&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:59&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:93&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:101&#125;]&#125;,&quot;value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:2&#125;]&#125;,&quot;null_value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:0&#125;]&#125;,&quot;nan_value_counts&quot;:&#123;&quot;array&quot;:[]&#125;,&quot;lower_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;abc&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221011&quot;&#125;]&#125;,&quot;upper_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0002\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;qjj&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221011&quot;&#125;]&#125;,&quot;key_metadata&quot;:null,&quot;split_offsets&quot;:&#123;&quot;array&quot;:[4]&#125;,&quot;sort_order_id&quot;:&#123;&quot;int&quot;:0&#125;&#125;&#125;</code></pre>
<p><strong>HiveCatalogè¡¨å…ƒæ•°æ®è§£æ</strong><br>MetadataFileæ–‡ä»¶ 00001-66c5832f-9d6d-4674-9a52-2aa6b8e29991.metadata.json </p>
<pre><code class="json">&#123;
  &quot;format-version&quot; : 1,
  &quot;table-uuid&quot; : &quot;5397c8ee-2b24-4eea-83ae-55e024ccd2c0&quot;,
  &quot;location&quot; : &quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table&quot;,
  &quot;last-updated-ms&quot; : 1665470339331,
  &quot;last-column-id&quot; : 4,
  &quot;schema&quot; : &#123;
    &quot;type&quot; : &quot;struct&quot;,
    &quot;schema-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;id&quot; : 1,
      &quot;name&quot; : &quot;id&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;long&quot;
    &#125;, &#123;
      &quot;id&quot; : 2,
      &quot;name&quot; : &quot;name&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125;, &#123;
      &quot;id&quot; : 3,
      &quot;name&quot; : &quot;age&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;int&quot;
    &#125;, &#123;
      &quot;id&quot; : 4,
      &quot;name&quot; : &quot;dt&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125; ]
  &#125;,
  &quot;current-schema-id&quot; : 0,
  &quot;schemas&quot; : [ &#123;
    &quot;type&quot; : &quot;struct&quot;,
    &quot;schema-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;id&quot; : 1,
      &quot;name&quot; : &quot;id&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;long&quot;
    &#125;, &#123;
      &quot;id&quot; : 2,
      &quot;name&quot; : &quot;name&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125;, &#123;
      &quot;id&quot; : 3,
      &quot;name&quot; : &quot;age&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;int&quot;
    &#125;, &#123;
      &quot;id&quot; : 4,
      &quot;name&quot; : &quot;dt&quot;,
      &quot;required&quot; : false,
      &quot;type&quot; : &quot;string&quot;
    &#125; ]
  &#125; ],
  &quot;partition-spec&quot; : [ &#123;
    &quot;name&quot; : &quot;dt&quot;,
    &quot;transform&quot; : &quot;identity&quot;,
    &quot;source-id&quot; : 4,
    &quot;field-id&quot; : 1000
  &#125; ],
  &quot;default-spec-id&quot; : 0,
  &quot;partition-specs&quot; : [ &#123;
    &quot;spec-id&quot; : 0,
    &quot;fields&quot; : [ &#123;
      &quot;name&quot; : &quot;dt&quot;,
      &quot;transform&quot; : &quot;identity&quot;,
      &quot;source-id&quot; : 4,
      &quot;field-id&quot; : 1000
    &#125; ]
  &#125; ],
  &quot;last-partition-id&quot; : 1000,
  &quot;default-sort-order-id&quot; : 0,
  &quot;sort-orders&quot; : [ &#123;
    &quot;order-id&quot; : 0,
    &quot;fields&quot; : [ ]
  &#125; ],
  &quot;properties&quot; : &#123;
    &quot;engine.hive.enabled&quot; : &quot;true&quot;,
    &quot;write.metadata.previous-versions-max&quot; : &quot;5&quot;,
    &quot;bucketing_version&quot; : &quot;2&quot;,
    &quot;write.metadata.delete-after-commit.enabled&quot; : &quot;true&quot;,
    &quot;write.distribution-mode&quot; : &quot;hash&quot;,
    &quot;storage_handler&quot; : &quot;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&quot;
  &#125;,
  &quot;current-snapshot-id&quot; : 6283861985931247372,
  &quot;refs&quot; : &#123;
    &quot;main&quot; : &#123;
      &quot;snapshot-id&quot; : 6283861985931247372,
      &quot;type&quot; : &quot;branch&quot;
    &#125;
  &#125;,
  &quot;snapshots&quot; : [ &#123;
    &quot;snapshot-id&quot; : 6283861985931247372,
    &quot;timestamp-ms&quot; : 1665470339331,
    &quot;summary&quot; : &#123;
      &quot;operation&quot; : &quot;append&quot;,
      &quot;added-data-files&quot; : &quot;2&quot;,
      &quot;added-records&quot; : &quot;3&quot;,
      &quot;added-files-size&quot; : &quot;2438&quot;,
      &quot;changed-partition-count&quot; : &quot;2&quot;,
      &quot;total-records&quot; : &quot;3&quot;,
      &quot;total-files-size&quot; : &quot;2438&quot;,
      &quot;total-data-files&quot; : &quot;2&quot;,
      &quot;total-delete-files&quot; : &quot;0&quot;,
      &quot;total-position-deletes&quot; : &quot;0&quot;,
      &quot;total-equality-deletes&quot; : &quot;0&quot;
    &#125;,
    &quot;manifest-list&quot; : &quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table/metadata/snap-6283861985931247372-1-825f6beb-3be7-485c-b338-8dec6068be94.avro&quot;,
    &quot;schema-id&quot; : 0
  &#125; ],
  &quot;snapshot-log&quot; : [ &#123;
    &quot;timestamp-ms&quot; : 1665470339331,
    &quot;snapshot-id&quot; : 6283861985931247372
  &#125; ],
  &quot;metadata-log&quot; : [ &#123;
    &quot;timestamp-ms&quot; : 1665470256700,
    &quot;metadata-file&quot; : &quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table/metadata/00000-d4b0dc94-f59f-4968-950c-31d22c2aab0d.metadata.json&quot;
  &#125; ]
&#125;</code></pre>
<p>ManifestListæ¸…å•åˆ—è¡¨æ–‡ä»¶   snap-6283861985931247372-1-825f6beb-3be7-485c-b338-8dec6068be94.avro</p>
<pre><code class="json">&#123;&quot;manifest_path&quot;:&quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table/metadata/825f6beb-3be7-485c-b338-8dec6068be94-m0.avro&quot;,&quot;manifest_length&quot;:6234,&quot;partition_spec_id&quot;:0,&quot;added_snapshot_id&quot;:&#123;&quot;long&quot;:6283861985931247372&#125;,&quot;added_data_files_count&quot;:&#123;&quot;int&quot;:2&#125;,&quot;existing_data_files_count&quot;:&#123;&quot;int&quot;:0&#125;,&quot;deleted_data_files_count&quot;:&#123;&quot;int&quot;:0&#125;,&quot;partitions&quot;:&#123;&quot;array&quot;:[&#123;&quot;contains_null&quot;:false,&quot;contains_nan&quot;:&#123;&quot;boolean&quot;:false&#125;,&quot;lower_bound&quot;:&#123;&quot;bytes&quot;:&quot;20221010&quot;&#125;,&quot;upper_bound&quot;:&#123;&quot;bytes&quot;:&quot;20221011&quot;&#125;&#125;]&#125;,&quot;added_rows_count&quot;:&#123;&quot;long&quot;:3&#125;,&quot;existing_rows_count&quot;:&#123;&quot;long&quot;:0&#125;,&quot;deleted_rows_count&quot;:&#123;&quot;long&quot;:0&#125;&#125;</code></pre>
<p>ManifestFileæ¸…å•æ–‡ä»¶ 825f6beb-3be7-485c-b338-8dec6068be94-m0.avro</p>
<pre><code class="json">&#123;&quot;status&quot;:1,&quot;snapshot_id&quot;:&#123;&quot;long&quot;:6283861985931247372&#125;,&quot;data_file&quot;:&#123;&quot;file_path&quot;:&quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table/data/dt=20221011/00000-0-shmily_20221011143858_89f7e99f-7227-4b19-9a44-b6807cf3b718-job_local1764035342_0002-00001.parquet&quot;,&quot;file_format&quot;:&quot;PARQUET&quot;,&quot;partition&quot;:&#123;&quot;dt&quot;:&#123;&quot;string&quot;:&quot;20221011&quot;&#125;&#125;,&quot;record_count&quot;:2,&quot;file_size_in_bytes&quot;:1272,&quot;block_size_in_bytes&quot;:67108864,&quot;column_sizes&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:55&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:59&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:93&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:101&#125;]&#125;,&quot;value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:2&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:2&#125;]&#125;,&quot;null_value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:0&#125;]&#125;,&quot;nan_value_counts&quot;:&#123;&quot;array&quot;:[]&#125;,&quot;lower_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;abc&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221011&quot;&#125;]&#125;,&quot;upper_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0002\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;qjj&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221011&quot;&#125;]&#125;,&quot;key_metadata&quot;:null,&quot;split_offsets&quot;:&#123;&quot;array&quot;:[4]&#125;,&quot;sort_order_id&quot;:&#123;&quot;int&quot;:0&#125;&#125;&#125;
&#123;&quot;status&quot;:1,&quot;snapshot_id&quot;:&#123;&quot;long&quot;:6283861985931247372&#125;,&quot;data_file&quot;:&#123;&quot;file_path&quot;:&quot;hdfs://shmily:8020/user/hive/warehouse/iceberg_db.db/hive_iceberg_partitioned_table/data/dt=20221010/00000-0-shmily_20221011143858_89f7e99f-7227-4b19-9a44-b6807cf3b718-job_local1764035342_0002-00002.parquet&quot;,&quot;file_format&quot;:&quot;PARQUET&quot;,&quot;partition&quot;:&#123;&quot;dt&quot;:&#123;&quot;string&quot;:&quot;20221010&quot;&#125;&#125;,&quot;record_count&quot;:1,&quot;file_size_in_bytes&quot;:1166,&quot;block_size_in_bytes&quot;:67108864,&quot;column_sizes&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:51&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:53&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:51&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:59&#125;]&#125;,&quot;value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:1&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:1&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:1&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:1&#125;]&#125;,&quot;null_value_counts&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:0&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:0&#125;]&#125;,&quot;nan_value_counts&quot;:&#123;&quot;array&quot;:[]&#125;,&quot;lower_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0003\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;abc&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221010&quot;&#125;]&#125;,&quot;upper_bounds&quot;:&#123;&quot;array&quot;:[&#123;&quot;key&quot;:1,&quot;value&quot;:&quot;\u0003\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:2,&quot;value&quot;:&quot;abc&quot;&#125;,&#123;&quot;key&quot;:3,&quot;value&quot;:&quot;\u0018\u0000\u0000\u0000&quot;&#125;,&#123;&quot;key&quot;:4,&quot;value&quot;:&quot;20221010&quot;&#125;]&#125;,&quot;key_metadata&quot;:null,&quot;split_offsets&quot;:&#123;&quot;array&quot;:[4]&#125;,&quot;sort_order_id&quot;:&#123;&quot;int&quot;:0&#125;&#125;&#125;</code></pre>
<h3 id="Icebergè¡¨ç±»å‹"><a href="#Icebergè¡¨ç±»å‹" class="headerlink" title="Icebergè¡¨ç±»å‹"></a>Icebergè¡¨ç±»å‹</h3><p>å½“Icebergæ·»åŠ äº†æ–°ç‰¹æ€§ä½†è¯¥æ–°ç‰¹æ€§ç ´åäº†å‘å‰å…¼å®¹æ€§æ—¶,è¡¨çš„versionä¼šå¢åŠ ,ä»¥ä¿è¯æ—§çš„è¡¨ç‰ˆæœ¬ä»ç„¶å¯ä»¥å…¼å®¹.<br>Icebergå½“å‰æœ‰V1å’ŒV2ä¸¤ç§è¡¨ç±»å‹,å»ºè¡¨æ—¶ç”±property-versionæŒ‡å®š.<br><a target="_blank" rel="noopener" href="https://iceberg.apache.org/spec/#version-1-analytic-data-tables">Version 1: Analytic Data Tables ğŸ”—</a> åŸºäºä¸å¯å˜æ–‡ä»¶æ ¼å¼ç®¡ç†çš„å¤§å‹åˆ†æè¡¨<br>V1è¡¨å¯ä»¥æŒ‰åˆ†åŒºåˆ é™¤æ•°æ®(å¦‚åœ¨Trinoä¸­delete from iceberg_table where ds=â€™2022120114â€™;),åˆ é™¤å¹¶ä¸ä¼šçœŸæ­£åˆ é™¤æ•°æ®,è€Œæ˜¯commitæ–°çš„å…ƒæ•°æ®æ–°çš„å¿«ç…§,åªè¦æ—§å¿«ç…§æœªè¿‡æœŸ,ä»ç„¶å¯ä»¥å›æ»šåˆ°åˆ é™¤å‰çš„çŠ¶æ€,ä½†ä¸€æ—¦å¿«ç…§è¿‡æœŸ,æ•°æ®æ–‡ä»¶ä¼šè¢«åˆ é™¤æ— æ³•è¿˜åŸ;V1è¡¨ä¸æ”¯æŒè¡Œçº§åˆ é™¤(ä¼šæŠ¥é”™failed: Iceberg table updates require at least format version 2)</p>
<p><a target="_blank" rel="noopener" href="https://iceberg.apache.org/spec/#version-2-row-level-deletes">Version 2: Row-level Deletes ğŸ”—</a> è¾ƒVersion 1æ·»åŠ äº†è¡Œçº§æ›´æ–°\åˆ é™¤èƒ½åŠ›;æ·»åŠ äº†Delete filesä»¥å¯¹ç°æœ‰æ•°æ®æ–‡ä»¶ä¸­åˆ é™¤çš„è¡Œè¿›è¡Œç¼–ç ã€‚Version2å¯å®ç°åˆ é™¤æˆ–æ›¿æ¢ä¸å¯å˜æ•°æ®æ–‡ä»¶ä¸­çš„å•ä¸ªè¡Œï¼Œè€Œæ— éœ€é‡å†™æ–‡ä»¶ã€‚</p>
<h3 id="Icebergè¡¨æ•°æ®ç±»å‹"><a href="#Icebergè¡¨æ•°æ®ç±»å‹" class="headerlink" title="Icebergè¡¨æ•°æ®ç±»å‹"></a>Icebergè¡¨æ•°æ®ç±»å‹</h3><table>
<thead>
<tr>
<th>æ•°æ®ç±»å‹</th>
<th>ä»‹ç»</th>
<th>è¦æ±‚</th>
</tr>
</thead>
<tbody><tr>
<td>int</td>
<td>32ä½æœ‰ç¬¦å·æ•´å½¢</td>
<td>å¯è½¬ä¸ºlong</td>
</tr>
<tr>
<td>long</td>
<td>64ä½æœ‰ç¬¦å·æ•´å½¢</td>
<td></td>
</tr>
<tr>
<td>float</td>
<td>å•ç²¾åº¦æµ®ç‚¹å‹</td>
<td>å¯è½¬ä¸ºdouble</td>
</tr>
<tr>
<td>double</td>
<td>åŒç²¾åº¦æµ®ç‚¹å‹</td>
<td></td>
</tr>
<tr>
<td>decimal(P,S)</td>
<td>å›ºå®šå°æ•°ç‚¹ç±»å‹æ•°å€¼</td>
<td>ç²¾åº¦P,å†³å®šæ€»ä½æ•°;æ¯”ä¾‹S,å†³å®šå°æ•°ä½æ•°;På¿…é¡»å°äºç­‰äº38</td>
</tr>
<tr>
<td>date</td>
<td>æ—¥æœŸ,ä¸å«æ—¶é—´å’Œæ—¶åŒº</td>
<td></td>
</tr>
<tr>
<td>time</td>
<td>æ—¶é—´,ä¸å«æ—¥æœŸå’Œæ—¶åŒº</td>
<td>ä»¥å¾®å¦™å­˜å‚¨</td>
</tr>
<tr>
<td>timestamp</td>
<td>ä¸å«æ—¶åŒºçš„æ—¶é—´æˆ³</td>
<td>ä»¥å¾®å¦™å­˜å‚¨</td>
</tr>
<tr>
<td>timestamptz</td>
<td>å«æ—¶åŒºçš„æ—¶é—´æˆ³</td>
<td>ä»¥å¾®å¦™å­˜å‚¨</td>
</tr>
<tr>
<td>string</td>
<td>å­—ç¬¦ä¸²,ä»»æ„é•¿åº¦</td>
<td>Encoded with UTF-8</td>
</tr>
<tr>
<td>fixed(L)</td>
<td>å›ºå®šé•¿åº¦ä¸ºLçš„å­—èŠ‚æ•°ç»„</td>
<td></td>
</tr>
<tr>
<td>binary</td>
<td>ä»»æ„é•¿åº¦å­—èŠ‚æ•°ç»„</td>
<td></td>
</tr>
<tr>
<td>struct&lt;â€¦&gt;</td>
<td>ä»»æ„æ•°æ®ç±»å‹ç»„æˆçš„ç»“æ„ä½“</td>
<td></td>
</tr>
<tr>
<td>list</td>
<td>ä»»æ„æ•°æ®ç±»å‹ç»„æˆçš„List</td>
<td></td>
</tr>
<tr>
<td>map&lt;K,V&gt;</td>
<td>ä»»æ„æ•°æ®ç±»å‹ç»„æˆçš„é”®å€¼å¯¹</td>
<td>è¡Œå­˜å‚¨ç±»å‹,å­˜å‚¨å’Œæ£€ç´¢æ—¶æ‰«ææ•°æ®é‡è¾ƒå¤§</td>
</tr>
</tbody></table>
<h2 id="Icebergé›†æˆ"><a href="#Icebergé›†æˆ" class="headerlink" title="Icebergé›†æˆ"></a>Icebergé›†æˆ</h2><h3 id="Icebergä¸Hiveé›†æˆ"><a href="#Icebergä¸Hiveé›†æˆ" class="headerlink" title="Icebergä¸Hiveé›†æˆ"></a>Icebergä¸Hiveé›†æˆ</h3><p>æ·»åŠ iceberg-hive-runtime-0.14.1.jar,libfb303-0.9.3.jarä¸¤ä¸ªjaråˆ°$HIVE_HOME/auxlibä¸‹<br>æ·»åŠ <strong>iceberg.engine.hive.enabled=true</strong>å‚æ•°åˆ°hive-site.xml</p>
<p>Hiveåˆ›å»ºIcebergè¡¨<br>(Hiveæ“ä½œIcebergæ”¯æŒå¤šç§Catalogï¼Œæ”¯æŒHadoopã€Hive(é»˜è®¤)ã€location_based_tableã€Customå‡ ç§ç®¡ç†æ–¹å¼,å…¶ä¸­å‰ä¸‰ç§æ˜¯å¼€ç®±å³ç”¨çš„)</p>
<p>1.<strong>HiveCatalog</strong>ç±»å‹(è¡¨å…ƒæ•°æ®ä¿¡æ¯ä½¿ç”¨HiveMetaStoreæ¥ç®¡ç†ï¼Œä¾èµ–Hive):</p>
<pre><code class="sql">-- ä¸è®¾ç½®Catalogç±»å‹æ—¶é»˜è®¤ä¼šä½¿ç”¨HiveCatalogç±»å‹çš„Icebergè¡¨
-- ç¤ºä¾‹1 éåˆ†åŒºè¡¨
CREATE TABLE iceberg_db.hive_iceberg_table (
  id BIGINT,
  name STRING
)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
LOCATION &#39;/user/hive/warehouse/iceberg_db.db/hive_iceberg_table&#39;
TBLPROPERTIES (
 &#39;write.distribution-mode&#39;=&#39;hash&#39;,  -- æ•°æ®å†™å…¥å‚æ•°,è®¾ç½®ä¸ºhashè¡¨ç¤ºæŒ‰keyå“ˆå¸Œ,æ¯ä¸€ä¸ªPartitionæ•°æ®æœ€å¤šç”±ä¸€ä¸ªTaskæ¥å†™å…¥ï¼Œå‡å°‘å°æ–‡ä»¶
 &#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,   -- (æ¯æ¬¡æäº¤åæ˜¯å¦åˆ é™¤æ—§å…ƒæ•°æ®æ–‡ä»¶) è‡ªåŠ¨æ¸…ç†æ—§å…ƒæ•°æ® metadata.json ä¸èƒ½æ¸…ç†manifestå’Œsnapshotçš„avroæ–‡ä»¶
 &#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;  -- ä¿ç•™çš„metadata.jsonæ•°é‡
);
-- ç¤ºä¾‹2 åˆ†åŒºè¡¨
CREATE TABLE iceberg_db.hive_iceberg_partitioned_table (
  id BIGINT,
  name STRING,
  age int
) partitioned by (dt string)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
TBLPROPERTIES (
 &#39;write.distribution-mode&#39;=&#39;hash&#39;,
 &#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
 &#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;,
 &#39;format-version&#39;=&#39;2&#39;,
 &#39;engine.hive.enabled&#39;=&#39;true&#39;, 
 &#39;write.target-file-size-bytes&#39;=&#39;268435456&#39;,
 &#39;write.format.default&#39;=&#39;parquet&#39;,
 &#39;write.parquet.compression-codec&#39;=&#39;zstd&#39;,
 &#39;write.parquet.compression-level&#39;=&#39;10&#39;,
 &#39;write.avro.compression-codec&#39;=&#39;zstd&#39;,
 &#39;write.avro.compression-level&#39;=&#39;10&#39;
);
-- ç¤ºä¾‹3 æ‰‹åŠ¨æŒ‡å®šcatalogåç§°,æŒ‡å®šcatalogç±»å‹ä¸ºHiveCatalogç±»å‹å¹¶å»ºè¡¨:
set iceberg.catalog.&lt;catalog_name&gt;.type=hive;  -- è®¾ç½®catalogç±»å‹
CREATE TABLE iceberg_db.hive_iceberg_partitioned_table (
  id BIGINT,
  name STRING,
  age int
) partitioned by (dt string)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
TBLPROPERTIES (
&#39;iceberg.catalog&#39;=&#39;&lt;catalog_name&gt;&#39;,
 &#39;write.distribution-mode&#39;=&#39;hash&#39;,
 &#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
 &#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;
);</code></pre>
<p>HiveCatalogè¡¨åœ¨HMSä¸­ä¿å­˜äº†å¾ˆå¤šTable Parametersä¿¡æ¯,å¦‚current-schema,current-snapshot-xx,default-partition-spec,metadata_location,previous_metadata_location,snapshot-countç­‰ä¿¡æ¯.</p>
<p>HiveCatalogè¡¨åœ¨Hiveä¸‹å­˜åœ¨çš„é—®é¢˜: åœ¨Kerberosè®¤è¯çš„HMSç¯å¢ƒä¸‹,Hiveå®¢æˆ·ç«¯å¯ä»¥å»ºè¡¨å’ŒæŸ¥è¯¢,ä½†æ— æ³•inssertæ•°æ®;å¯ä»¥ä½¿ç”¨beeline+hiveserver2è¿›è¡ŒIcebergè¡¨çš„insertæ“ä½œ.<br>é€‚ç”¨åœºæ™¯: HiveCatalogåœ¨å…¼å®¹æ€§æ–¹é¢æœ‰å¤©ç„¶çš„ä¼˜åŠ¿,å‡ ä¹å¤§éƒ¨åˆ†å¸¸è§è®¡ç®—å¼•æ“éƒ½æ”¯æŒHiveCatalog,è€Œå…¶ä»–ç±»å‹çš„Catalogåˆ™æœ‰ä¸è¢«è®¡ç®—å¼•æ“æ”¯æŒçš„å¯èƒ½.å°¤å…¶æ˜¯å¦‚æœä½¿ç”¨Icebergè‡ªå®šä¹‰Catalog,åˆ™éœ€è¦ä¸ºæ¯ä¸ªè¯•ç”¨Icebergçš„å¼•æ“åšä¸€å®šçš„å¼€å‘å·¥ä½œä»¥å…¼å®¹è‡ªå®šä¹‰Catalog.</p>
<p>2.<strong>HadoopCatalog</strong>ç±»å‹(å…ƒæ•°æ®ä¿¡æ¯ä½¿ç”¨åº•å±‚å¤–éƒ¨å­˜å‚¨æ¥ç®¡ç†)</p>
<pre><code class="sql">set iceberg.catalog.&lt;catalog_name&gt;.type=hadoop;  -- å¿…é¡»æ¯æ¬¡è®¾ç½®catalogç±»å‹
set iceberg.catalog.&lt;catalog_name&gt;.warehouse=hdfs://nameservice/user/iceberg/warehouse;  -- å¿…é¡»æ¯æ¬¡è®¾ç½®warehouseå­˜å‚¨è·¯å¾„
create external table iceberg_db.hadoop_iceberg_partitioned_table (
  id BIGINT,
  name STRING,
  age int
) partitioned by (dt string)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
LOCATION &#39;hdfs://nameservice/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_partitioned_table&#39;  -- è·¯å¾„å¿…é¡»æ˜¯$&#123;iceberg.catalog.&lt;catalog_name&gt;.warehous&#125;/$&#123;db_name&#125;/$&#123;table_name&#125;
tblproperties (
    &#39;iceberg.catalog&#39;=&#39;&lt;catalog_name&gt;&#39;,
    &#39;write.distribution-mode&#39;=&#39;hash&#39;,
    &#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
    &#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;
);</code></pre>
<p>3.<strong>LocationBasedTable</strong>(å¤–éƒ¨å­˜å‚¨ä¸­<strong>å·²ç»å­˜åœ¨HadoopCatalogç±»å‹Icebergè¡¨</strong>çš„æ•°æ®,å°†å…¶<strong>æ˜ å°„</strong>åˆ°Hiveè¡¨)<br>HDFSå·²ç»å­˜åœ¨äº†Icebergæ ¼å¼è¡¨çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®štblproperties(â€˜iceberg.catalogâ€™=â€™location_based_tableâ€™)å’ŒLOCATION,å®ƒä¼šå»æŒ‡å®šçš„LOCATIONè·¯å¾„ä¸‹åŠ è½½icebergè¡¨æ•°æ®.å‰æLOCATIONä¸‹å·²ç»å­˜åœ¨Icebergæ ¼å¼è¡¨æ•°æ®äº†.<br>å»ºè¡¨æ—¶ä¸éœ€è¦åŠ PARTITION BY,åªéœ€è¦åŠ å­—æ®µå³å¯.</p>
<pre><code class="sql">create external table iceberg_db.location_iceberg_partitioned_table (
  id BIGINT,
  name STRING,
  age INT,
  dt STRING
)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
LOCATION &#39;hdfs://nameservice/user/iceberg/warehouse/iceberg_db/location_iceberg_partitioned_table&#39;
tblproperties (&#39;iceberg.catalog&#39;=&#39;location_based_table&#39;);
æˆ–
create table iceberg_db.location_iceberg_partitioned_table (
  id BIGINT,
  name STRING,
  age INT,
  dt STRING
)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
LOCATION &#39;hdfs://nameservice/user/iceberg/warehouse/iceberg_db/location_iceberg_partitioned_table&#39;
tblproperties (&#39;iceberg.catalog&#39;=&#39;location_based_table&#39;);</code></pre>
<p>æ¨èåœºæ™¯: å¤–éƒ¨è®¡ç®—å¼•æ“å‡æ”¯æŒHadoopCatalogç±»å‹Icebergè¡¨çš„æƒ…å†µä¸‹,æ¯”å¦‚Flinkã€Sparkç­‰å¼•æ“å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºHiveè¡¨æ¥æ‰“é€šHive.<br>ä¸æ¨èåœºæ™¯: éœ€è¦ä½¿ç”¨Trinoåˆ†æè¯¥è¡¨.(å› ä¸ºTrinoå½“å‰ä¸æ”¯æŒHadoopCatalogç±»å‹Icebergè¡¨)<br>æ³¨æ„: <strong>å¤–éƒ¨å­˜å‚¨ä¸Šçš„Icebergè¡¨,Catalogå¿…é¡»æ˜¯HadoopCatalogç±»å‹çš„ï¼Œå¦åˆ™æ— æ³•è¯»å–æ•°æ®ã€‚</strong>å¦‚æœæ˜¯å…¶ä»–Catalogç±»å‹,è¡¨åˆ›å»ºæ—¶ä¼šæŠ¥é”™File does not exist: /table_pathâ€¦/metadata/version-hint.textï¼Œè¡¨èƒ½åˆ›å»ºæˆåŠŸï¼Œä½†æŸ¥è¯¢ç»“æœä¸ºç©ºã€‚</p>
<p>4.<strong>CustomCatalog</strong>è‡ªå®šä¹‰Catalog,é€šè¿‡Icebergæä¾›çš„APIå®šåˆ¶Catalog,ä½¿Icebergèƒ½æ›´åŠ çµæ´»åœ°ä½¿ç”¨å„ç±»å…ƒæ•°æ®ç®¡ç†æ–¹æ¡ˆ.<br>é€‚ç”¨åœºæ™¯: éœ€è¦ä¸Hive Hadoopç­‰è§£è€¦çš„åœºæ™¯,ä»¥åŠéœ€è¦çµæ´»ç®¡ç†å…ƒæ•°æ®çš„åœºæ™¯.åœ¨å…ƒæ•°æ®ç®¡ç†å’Œå…¼å®¹è®¡ç®—å¼•æ“æ–¹é¢éœ€è¦ä¸€å®šçš„å¼€å‘å·¥ä½œé‡.</p>
<h3 id="Icebergä¸Flinké›†æˆ"><a href="#Icebergä¸Flinké›†æˆ" class="headerlink" title="Icebergä¸Flinké›†æˆ"></a>Icebergä¸Flinké›†æˆ</h3><p>Flink 1.14åˆ™ä¸‹è½½iceberg-flink-runtime-1.14-0.14.1.jar æ”¾å…¥$FLINK_HOME/libç›®å½•ä¸‹</p>
<ol>
<li><p>Flink DataStreamAPIé›†æˆIceberg<br>å†™äº†å‡ ä¸ªæ¡ˆä¾‹:<br>Kafkaæ•°æ®é€šè¿‡Flink Datastream APIå†™å…¥Iceberg:<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Flink/src/main/java/flink/study/streaming/sink/iceberg/KafkaSinkHadoopCatalogIcebergTable.java"><strong>KafkaSinkHadoopCatalogIcebergTable</strong></a><br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Flink/src/main/java/flink/study/streaming/sink/iceberg/KafkaSinkHiveCatalogIcebergTable.java"><strong>KafkaSinkHiveCatalogIcebergTable</strong></a><br>é€šè¿‡Flink Datastream APIè¯»å–Iceberg:<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Flink/src/main/java/flink/study/streaming/source/iceberg/HadoopCatalogIcebergTableSource.java"><strong>HadoopCatalogIcebergTableSource</strong></a><br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Flink/src/main/java/flink/study/streaming/source/iceberg/HiveCatalogIcebergTableSource.java"><strong>HiveCatalogIcebergTableSource</strong></a></p>
</li>
<li><p>Flink SQLé›†æˆIceberg</p>
</li>
</ol>
<p><strong>æ‰“é€šKafka-&gt;Flink SQL-&gt;HadoopCatalogç±»å‹Icebergè¡¨-&gt;Hive</strong></p>
<pre><code class="sql">-- å¯åŠ¨flinké›†ç¾¤ï¼šcd $FLINK_HOME ; bin/start-cluster.sh
-- å¯åŠ¨FlinkSQL Consoleï¼šbin/sql-client.sh embedded shell
set execution.checkpointing.interval=10sec; -- å¿…é¡»è®¾ç½®checkpoint  é checkpointæäº¤æ›´æ–°æ•°æ®åˆ°Iceberg
SET execution.runtime-mode = streaming;  -- æµå¼å†™
CREATE TABLE t_kafka_source (
    id BIGINT,
    name STRING,
    age INT,
    dt STRING
) WITH (
    &#39;connector&#39; = &#39;kafka&#39;,
    &#39;topic&#39; = &#39;flink_topic1&#39;,  
    &#39;scan.startup.mode&#39; = &#39;latest-offset&#39;,
    &#39;properties.bootstrap.servers&#39; = &#39;cdh101:9092,cdh102:9092,cdh103:9092,cdh104:9092&#39;,
    &#39;properties.group.id&#39; = &#39;test&#39;,
    &#39;format&#39; = &#39;csv&#39;
);
-- 1.å†™å…¥Icebergè¡¨[HadoopCatalogç±»å‹]
CREATE CATALOG hadoop_iceberg_catalog WITH (
  &#39;type&#39;=&#39;iceberg&#39;,  -- åˆ›å»ºHadoopCatalogç±»å‹Icebergè¡¨åœ¨FlinkSQLä¸­çš„Catalog
  &#39;catalog-type&#39;=&#39;hadoop&#39;,
  &#39;warehouse&#39;=&#39;hdfs://nameservice/user/iceberg/warehouse&#39;,
  &#39;property-version&#39;=&#39;1&#39;
);
CREATE TABLE if not exists `hadoop_iceberg_catalog`.`iceberg_db`.`hadoop_iceberg_table_flink_sql` (
   id BIGINT,
   name STRING,
   age INT,
   dt STRING
) PARTITIONED BY (dt)
WITH(&#39;type&#39;=&#39;ICEBERG&#39;,
&#39;engine.hive.enabled&#39;=&#39;true&#39;,  -- æ”¯æŒhiveæŸ¥è¯¢(å®æµ‹å‘ç°ä¸åŠ ä¹Ÿæ²¡å½±å“)
&#39;read.split.target-size&#39;=&#39;1073741824&#39;, -- å‡å°‘splitæ•°æå‡æŸ¥è¯¢æ•ˆç‡
&#39;write.target-file-size-bytes&#39;=&#39;134217728&#39;,
&#39;write.format.default&#39;=&#39;parquet&#39;,
&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
&#39;write.metadata.previous-versions-max&#39;=&#39;9&#39;,  
&#39;write.distribution-mode&#39;=&#39;hash&#39;); 
insert into hadoop_iceberg_catalog.iceberg_db.hadoop_iceberg_table_flink_sql select id,name,age,dt from t_kafka_source;
-- 2.FlinkSQLæ‰¹å¼æŸ¥è¯¢
SET execution.runtime-mode = batch;
select id,name,age,dt from `hadoop_iceberg_catalog`.`iceberg_db`.`hadoop_iceberg_table_flink_sql`;
-- 3.FlinkSQLæµå¼æŸ¥è¯¢ 
---- æ³¨:ä¸æŒ‡å®šstart-snapshot-idåˆ™ä¼šé€æ¸å›æº¯å…¨é‡æ•°æ®
---- æŒ‡å®šäº†start-snapshot-idå,ä¼šä»è¯¥snapshotçš„æ•°æ®å¼€å§‹æ¶ˆè´¹
---- é‡å¯Flinkåº”ç”¨æ—¶,è‹¥ä¸æŒ‡å®šä¸Šæ¬¡å…³é—­æ—¶çš„checkpointæˆ–savepoint,åˆ™æ¯æ¬¡é‡å¯Flinkåº”ç”¨éƒ½ä¼šä»start-snapshot-idæŒ‡å®šsnapshotå¼€å§‹æ¶ˆè´¹,å¯¼è‡´é‡å¤æ¶ˆè´¹å†å²æ•°æ®
---- é‡å¯Flinkåº”ç”¨æ—¶,è‹¥æŒ‡å®šäº†ä¸Šæ¬¡å…³é—­æ—¶çš„checkpointæˆ–savepoint,åˆ™ä¼šä»ä¸Šæ¬¡æ¶ˆè´¹çš„ä½ç‚¹ç»§ç»­æ¶ˆè´¹
select id,name,age,dt from `hadoop_iceberg_catalog`.`iceberg_db`.`hadoop_iceberg_table_flink_sql` /*+ OPTIONS(&#39;streaming&#39;=&#39;true&#39;, &#39;monitor-interval&#39;=&#39;5s&#39;, &#39;start-snapshot-id&#39;=&#39;3821550127947089987&#39;)*/ ;
-- 4.åœ¨Hiveä¸­åˆ›å»ºIcebergæ˜ å°„è¡¨[åªé’ˆå¯¹HadoopCatalogç±»å‹è¡¨]
create external table iceberg_db.hadoop_iceberg_table_flink_sql (
  id BIGINT,
  name STRING,
  age INT,
  dt STRING
)
STORED BY &#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;
LOCATION &#39;hdfs://nameservice/user/iceberg/warehouse/iceberg_db/hadoop_iceberg_table_flink_sql&#39;
tblproperties (&#39;iceberg.catalog&#39;=&#39;location_based_table&#39;);
-- 5.HiveSQLæŸ¥è¯¢(èƒ½æŸ¥åˆ°å®æ—¶æœ€æ–°æ•°æ®)
select * from iceberg_db.hadoop_iceberg_table_flink_sql; 
-- 6.FlinkSQL Upsertæ›´æ–° åŸºäºç´¯ç§¯çª—å£ç»Ÿè®¡é€»è¾‘ (æ³¨æ„upsertæ¬¡æ•°è¿‡å¤šä¼šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½å¾ˆå·®,å¦‚æœé¢‘ç¹upsert,åˆ™éœ€è¦é¢‘ç¹åšcompactæ¥ä¿è¯æŸ¥è¯¢æ€§èƒ½,å¯æ ¹æ®éœ€è¦è®¾ç½®åªä¿ç•™1-3ä¸ªsnapshot)
CREATE TABLE if not exists `hive_iceberg_catalog`.`iceberg_db`.`summary_iceberg_table` (
  actionid STRING,
  userid STRING,
  `success_cnt` bigint,
  `failed_cnt` bigint,
  window_start TIMESTAMP(3) NOT NULL,
  window_end TIMESTAMP(3) NOT NULL,
  ds STRING,
  PRIMARY KEY(`actionid`,`userid`,`ds`) NOT ENFORCED  -- å¿…é¡»è®¾ç½®ä¸»é”® æ ¹æ®ä¸»é”®upsert
) PARTITIONED BY (ds)
WITH(&#39;type&#39;=&#39;ICEBERG&#39;,
&#39;format-version&#39;=&#39;2&#39;,   -- å¿…é¡»æ˜¯v2è¡¨
&#39;write.upsert.enabled&#39;=&#39;true&#39;,  -- æŒ‡å®šè¯¥å‚æ•° ä½¿è¡¨å¯upsert
&#39;engine.hive.enabled&#39;=&#39;true&#39;,  
&#39;read.split.target-size&#39;=&#39;536870912&#39;,
&#39;write.target-file-size-bytes&#39;=&#39;268435456&#39;,
&#39;write.format.default&#39;=&#39;parquet&#39;,
&#39;write.parquet.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.parquet.compression-level&#39;=&#39;10&#39;,
&#39;write.avro.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.avro.compression-level&#39;=&#39;10&#39;,
&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
&#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;,  
&#39;write.distribution-mode&#39;=&#39;hash&#39;); 
INSERT INTO `hive_iceberg_catalog`.`iceberg_db`.`summary_iceberg_table` /*+ OPTIONS(&#39;upsert-enabled&#39;=&#39;true&#39;) */   -- éœ€è¦æŒ‡å®š&#39;upsert-enabled&#39;=&#39;true&#39;
SELECT 
actionid,
userid,
sum(cast(if(`error` = &#39;ok&#39;, 1, 0) as BIGINT)) AS success_cnt,
sum(cast(if(`error` &lt;&gt; &#39;ok&#39;, 1, 0) as BIGINT)) AS failed_cnt,
window_start, 
window_end,
DATE_FORMAT(window_start, &#39;yyyyMMdd&#39;) AS ds
FROM 
    TABLE(
    CUMULATE(
      TABLE kafka_table, 
      DESCRIPTOR(event_time), 
      INTERVAL &#39;1&#39; MINUTES, 
      INTERVAL &#39;1&#39; DAY
      )
    )
  GROUP BY 
    window_start, 
    window_end,
    actionid,
    userid;
-- 7. FlinkSQL Upsertæ›´æ–° åŸºäºç´¯ç§¯çª—å£è®¡ç®—TopNé€»è¾‘ (æ³¨æ„upsertæ¬¡æ•°è¿‡å¤šä¼šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½å¾ˆå·®,å¦‚æœé¢‘ç¹upsert,åˆ™éœ€è¦é¢‘ç¹åšcompactæ¥ä¿è¯æŸ¥è¯¢æ€§èƒ½,å¯æ ¹æ®éœ€è¦è®¾ç½®åªä¿ç•™1-3ä¸ªsnapshot)
CREATE TABLE if not exists `hive_iceberg_catalog`.`iceberg_db`.`top_iceberg_table` (
  actionid STRING,
  success_cnt bigint,
  failed_cnt bigint,
  ranking_num bigint,
  window_start TIMESTAMP(3) NOT NULL,
  window_end TIMESTAMP(3) NOT NULL,
  ds STRING,
  PRIMARY KEY(`actionid`,`ds`) NOT ENFORCED  -- å¿…é¡»è®¾ç½®ä¸»é”® æ ¹æ®ä¸»é”®upsert
) PARTITIONED BY (ds)
WITH(&#39;type&#39;=&#39;ICEBERG&#39;,
&#39;format-version&#39;=&#39;2&#39;,    -- å¿…é¡»æ˜¯v2è¡¨
&#39;write.upsert.enabled&#39;=&#39;true&#39;,  -- æŒ‡å®šè¯¥å‚æ•° ä½¿è¡¨å¯upsert
&#39;engine.hive.enabled&#39;=&#39;true&#39;,  
&#39;read.split.target-size&#39;=&#39;536870912&#39;,
&#39;write.target-file-size-bytes&#39;=&#39;268435456&#39;,
&#39;write.format.default&#39;=&#39;parquet&#39;,
&#39;write.parquet.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.parquet.compression-level&#39;=&#39;10&#39;,
&#39;write.avro.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.avro.compression-level&#39;=&#39;10&#39;,
&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
&#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;,  
&#39;write.distribution-mode&#39;=&#39;hash&#39;);
INSERT INTO `hive_iceberg_catalog`.`iceberg_db`.`user_experience_topn_action_report` /*+ OPTIONS(&#39;upsert-enabled&#39;=&#39;true&#39;) */  -- éœ€è¦æŒ‡å®š&#39;upsert-enabled&#39;=&#39;true&#39;
SELECT * from (
    SELECT 
      actionid, 
      success_cnt, 
      failed_cnt, 
      ROW_NUMBER() OVER (
        PARTITION BY window_start, 
        window_end 
        ORDER BY 
          failed_cnt asc
      ) AS rn, 
      window_start, 
      window_end, 
      ds 
    from (
        select 
          actionid, 
          sum(cast(if(`error` = &#39;ok&#39;, 1, 0) as BIGINT)) AS success_cnt, 
          sum(cast(if(`error` &lt;&gt; &#39;ok&#39;, 1, 0) as BIGINT)) AS failed_cnt, 
          window_start, 
          window_end, 
          DATE_FORMAT(window_end, &#39;yyyyMMdd&#39;) AS ds 
        FROM 
          TABLE(
            CUMULATE(
              TABLE kafka_shoulei_odl_odl_xlpan_server_log, 
              DESCRIPTOR(event_time), 
              INTERVAL &#39;1&#39; MINUTES, 
              INTERVAL &#39;1&#39; DAY
            )
          ) 
        GROUP BY 
          window_start, 
          window_end, 
          actionid
      ) t_inner
  ) t_outer 
where 
  rn &lt;= 100;</code></pre>
<p><strong>æ‰“é€šKafka-&gt;Flink SQL-&gt;HiveCatalogç±»å‹Icebergè¡¨-&gt;Hive/Trino</strong></p>
<pre><code class="sql">-- å†™å…¥Icebergè¡¨[HiveCatalogç±»å‹]
-- å¯åŠ¨flinké›†ç¾¤ï¼šcd $FLINK_HOME ; bin/start-cluster.sh
-- å¯åŠ¨FlinkSQL Consoleï¼šbin/sql-client.sh embedded -j iceberg-flink-runtime-1.13-0.14.0.jar -j  /opt/cloudera/parcels/CDH/jars/hive-metastore-2.1.1-cdh6.3.1.jar -j /opt/cloudera/parcels/CDH/jars/libthrift-0.9.3.jar -j /opt/cloudera/parcels/CDH/jars/hive-common-2.1.1-cdh6.3.1.jar -j /opt/cloudera/parcels/CDH/jars/hive-serde-2.1.1-cdh6.3.1.jar -j /opt/cloudera/parcels/CDH/jars/libfb303-0.9.3.jar -j /opt/cloudera/parcels/CDH/jars/hive-shims-common-2.1.1-cdh6.3.1.jar shell
set execution.checkpointing.interval=10sec; -- å¿…é¡»è®¾ç½®checkpoint  é checkpointæäº¤æ›´æ–°æ•°æ®åˆ°Iceberg
SET execution.runtime-mode = streaming;  -- æµå¼å†™
CREATE TABLE t_kafka_source (
    id BIGINT,
    name STRING,
    age INT,
    dt STRING
) WITH (
    &#39;connector&#39; = &#39;kafka&#39;,
    &#39;topic&#39; = &#39;flink_topic1&#39;,  
    &#39;scan.startup.mode&#39; = &#39;latest-offset&#39;,
    &#39;properties.bootstrap.servers&#39; = &#39;cdh101:9092,cdh102:9092,cdh103:9092,cdh104:9092&#39;,
    &#39;properties.group.id&#39; = &#39;test&#39;,
    &#39;format&#39; = &#39;csv&#39;
);
CREATE CATALOG hive_iceberg_catalog WITH (
  &#39;type&#39;=&#39;iceberg&#39;,
  &#39;catalog-type&#39;=&#39;hive&#39;,
  &#39;uri&#39;=&#39;thrift://cdh101:9083,thrift://cdh103:9083&#39;,
  &#39;clients&#39;=&#39;5&#39;,
  &#39;property-version&#39;=&#39;1&#39;,
  &#39;warehouse&#39;=&#39;hdfs://nameservice/user/iceberg/warehouse&#39;,
  &#39;hive-conf-dir&#39;=&#39;/etc/ecm/hive-conf&#39;   -- å¦‚æœhiveæ˜¯kerberosè®¤è¯çš„,å¿…é¡»è¦åŠ hive-conf-dirå‚æ•°,ékerberosé›†ç¾¤å¯å¿½ç•¥
);
CREATE TABLE if not exists `hive_iceberg_catalog`.`iceberg_db`.`hive_iceberg_table_flink_sql` (
   id BIGINT,
   name STRING,
   age INT,
   dt STRING
) PARTITIONED BY (dt)
WITH(&#39;type&#39;=&#39;ICEBERG&#39;,
&#39;engine.hive.enabled&#39;=&#39;true&#39;,
&#39;read.split.target-size&#39;=&#39;1073741824&#39;,
&#39;write.target-file-size-bytes&#39;=&#39;536870912&#39;,
&#39;write.format.default&#39;=&#39;parquet&#39;,
&#39;write.parquet.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.parquet.compression-level&#39;=&#39;10&#39;,
&#39;write.avro.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.avro.compression-level&#39;=&#39;10&#39;,
&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
&#39;write.metadata.previous-versions-max&#39;=&#39;5&#39;,
&#39;write.distribution-mode&#39;=&#39;none&#39;);
insert into hive_iceberg_catalog.iceberg_db.hive_iceberg_table_flink_sql select id,name,age,dt from t_kafka_source;</code></pre>
<p>å†™å…¥HiveCatalogIcebergè¡¨åï¼Œåœ¨Hiveå¯ä»¥ç›´æ¥çœ‹åˆ°å¹¶æŸ¥è¯¢è¡¨iceberg_db.hive_iceberg_table_flink_sql.<br>ä¹Ÿå¯ä»¥å…ˆåœ¨hiveåˆ›å»ºè¡¨,å†Flinkå†™å…¥,å‡æ­£å¸¸.<br>Trinoä¸­ä¹Ÿå¯ä»¥ç›´æ¥çœ‹åˆ°å¹¶æŸ¥è¯¢è¯¥è¡¨.<br>3. StreamParké›†æˆIceberg(åŸºäºHiveCatalog)<br>StreamParkæ˜¯åŸºäºFlink SQLçš„æµå¼è®¡ç®—å¹³å°.åœ¨StreamParkä¸Šå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¼€å‘å®æ—¶æ“ä½œIcebergçš„Flinkä»»åŠ¡.<br>ç¯å¢ƒ: Hadoop 3.2.1 + Hive 3.1.2 + Iceberg 0.14.1 + Flink 1.14.5 + StreamPark 1.2.4 + OSS<br>FlinkSQLç¼–å†™:</p>
<pre><code class="sql">CREATE CATALOG hive_iceberg_catalog WITH (
  &#39;type&#39;=&#39;iceberg&#39;,
  &#39;catalog-type&#39;=&#39;hive&#39;,
  &#39;uri&#39;=&#39;thrift://thrift-host:9083&#39;,
  &#39;clients&#39;=&#39;5&#39;,
  &#39;property-version&#39;=&#39;1&#39;,
  &#39;warehouse&#39;=&#39;oss://bucket_name/data/iceberg/warehouse&#39;,
  &#39;hive-conf-dir&#39;=&#39;/etc/ecm/hive-conf&#39;
);
-- Kafka source table
CREATE TABLE t_kafka_source (
    id BIGINT,
    name STRING,
    age INT,
    dt STRING
) WITH (
    &#39;connector&#39; = &#39;kafka&#39;,
    &#39;topic&#39; = &#39;t_qjj_flink_test&#39;,  
    &#39;scan.startup.mode&#39; = &#39;latest-offset&#39;,
    &#39;properties.bootstrap.servers&#39; = &#39;broker1:9092,broker2:9092,broker3:9092&#39;,
    &#39;properties.group.id&#39; = &#39;test&#39;,
    &#39;format&#39; = &#39;csv&#39;
);
-- Iceberg target table
CREATE TABLE IF NOT EXISTS `hive_iceberg_catalog`.`iceberg_db`.`hive_krb_iceberg_table_flink_sql` (
   id BIGINT,
   name STRING,
   age INT,
   dt STRING
) PARTITIONED BY (dt)
WITH(&#39;type&#39;=&#39;ICEBERG&#39;,
&#39;engine.hive.enabled&#39;=&#39;true&#39;,
&#39;read.split.target-size&#39;=&#39;1073741824&#39;,
&#39;write.target-file-size-bytes&#39;=&#39;536870912&#39;,
&#39;write.format.default&#39;=&#39;parquet&#39;,
&#39;write.parquet.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.parquet.compression-level&#39;=&#39;10&#39;,
&#39;write.avro.compression-codec&#39;=&#39;zstd&#39;,
&#39;write.avro.compression-level&#39;=&#39;10&#39;,
&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39;,
&#39;write.metadata.previous-versions-max&#39;=&#39;10&#39;,
&#39;write.distribution-mode&#39;=&#39;none&#39;);
-- Insert data
insert into hive_iceberg_catalog.iceberg_db.hive_krb_iceberg_table_flink_sql select id,name,age,dt from t_kafka_source;</code></pre>
<p>ä¾èµ–jar:</p>
<pre><code class="xml">  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.iceberg&lt;/groupId&gt;
    &lt;artifactId&gt;iceberg-flink-runtime-1.14&lt;/artifactId&gt;
    &lt;version&gt;0.14.1&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
    &lt;artifactId&gt;hive-metastore&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt;
    &lt;artifactId&gt;libthrift&lt;/artifactId&gt;
    &lt;version&gt;0.9.3&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt;
    &lt;artifactId&gt;libfb303&lt;/artifactId&gt;
    &lt;version&gt;0.9.3&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
    &lt;artifactId&gt;hive-common&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
    &lt;artifactId&gt;hive-serde&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.hive.shims&lt;/groupId&gt;
    &lt;artifactId&gt;hive-shims-common&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
    &lt;artifactId&gt;flink-connector-kafka_2.12&lt;/artifactId&gt;
    &lt;version&gt;1.14.5&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;commons-cli&lt;/groupId&gt;
    &lt;artifactId&gt;commons-cli&lt;/artifactId&gt;
    &lt;version&gt;1.3.1&lt;/version&gt;
  &lt;/dependency&gt;</code></pre>
<p>å¯èƒ½å‡ºç°çš„å¼‚å¸¸:</p>
<pre><code class="err">Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: org.apache.commons.cli.Option.builder(Ljava/lang/String;)Lorg/apache/commons/cli/Option$Builder;
        at org.apache.flink.runtime.entrypoint.parser.CommandLineOptions.&lt;clinit&gt;(CommandLineOptions.java:27)</code></pre>
<p>åŸå› : streamxåœ¨ä¸‹è½½hiveä¾èµ–æ—¶,ä¸‹è½½äº†å®ƒçš„å­ä¾èµ–,ä¸”hiveä½¿ç”¨çš„commons-cliä¸streamxä½¿ç”¨çš„commons-cliç‰ˆæœ¬ä¸ä¸€è‡´,å¯¼è‡´jarå†²çª.<br>è§£å†³: æ¯æ¬¡buildåæ‰‹åŠ¨åˆ é™¤hdfs dfs -rm -f hdfs://ns/streamx/workspace/é¡¹ç›®ID/lib/commons-cli-1.2.jar</p>
<h3 id="Icebergä¸Trinoé›†æˆ"><a href="#Icebergä¸Trinoé›†æˆ" class="headerlink" title="Icebergä¸Trinoé›†æˆ"></a>Icebergä¸Trinoé›†æˆ</h3><p>Trinoæ•´åˆIcebergéœ€è¦é…ç½®$TRINO_HOME/etc/catalog/iceberg.propertieså†…å®¹å¦‚ä¸‹:</p>
<pre><code>connector.name=iceberg
iceberg.file-format=PARQUET
hive.metastore.service.principal=hive/metastore-server-ip@realm-name 
hive.metastore.authentication.type=KERBEROS
hive.metastore.uri=thrift://metastore-server-ip:9083,metastore-server-ip-bk:9083
hive.metastore.client.principal=principal-in-hive-keytab
hive.metastore.client.keytab=/path/to/hive.keytab
hive.config.resources=/etc/ecm/hadoop-conf/core-site.xml, /etc/ecm/hadoop-conf/hdfs-site.xml
iceberg.compression-codec=SNAPPY</code></pre>
<p>è‹¥éœ€è¦å…¶æ”¯æŒå¤–éƒ¨å­˜å‚¨ä¾‹å¦‚oss,åˆ™éœ€è¦å°†jindo-core-4.3.0.jarå’Œjindo-sdk-4.3.0.jarä¸¤ä¸ªjaræ‹·è´åˆ°$TRINO_HOME/plugin/iceberg/å’Œ$TRINO_HOME/plugin/hive/ä»¥å…¼å®¹å¤–éƒ¨å­˜å‚¨.</p>
<p>Trinoå½“å‰ä»…æ”¯æŒHiveCatalogç±»å‹çš„Icebergè¡¨,ä¸æ”¯æŒHadoopCatalogç±»å‹Icebergè¡¨.å¦‚æœæŸ¥è¯¢çš„æ˜¯HadoopCatalog,location_based_table,Customeç±»å‹çš„Icebergè¡¨ä¼šæŠ¥é”™:Table is missing [metadata_location] property: iceberg_db.iceberg_table</p>
<p>Trinoæ“ä½œIcebergè¡¨å¸¸ç”¨æ“ä½œ:</p>
<pre><code class="sql">1.æŸ¥çœ‹æœ‰å“ªäº›åˆ†åŒº
select * from &quot;iceberg_table$partitions&quot;;
2.æŸ¥çœ‹æœ‰å“ªäº›å¿«ç…§
select * from &quot;iceberg_table$snapshots&quot;;
SELECT snapshot_id,committed_at FROM &quot;iceberg_table$snapshots&quot; ORDER BY committed_at;
3.è¡¨ä¼˜åŒ– ä¹‹ å¿«ç…§è¿‡æœŸ
ALTER TABLE iceberg_table EXECUTE expire_snapshots(retention_threshold =&gt; &#39;7d&#39;)
4.è¡¨ä¼˜åŒ– ä¹‹ æ–‡ä»¶åˆå¹¶
ALTER TABLE iceberg_table EXECUTE optimize [é»˜è®¤åˆå¹¶å°äºfile_size_thresholdçš„æ•°æ®æ–‡ä»¶,file_size_thresholdé»˜è®¤100MB]
ALTER TABLE iceberg_table EXECUTE optimize(file_size_threshold =&gt; &#39;256MB&#39;)
ALTER TABLE iceberg_table EXECUTE optimize WHERE partition_key = 1 [æŒ‰åˆ†åŒºä¼˜åŒ–]
5.è¡¨ä¼˜åŒ– ä¹‹ æ¸…ç†å­¤ç«‹æ— æ•ˆçš„æ–‡ä»¶
ALTER TABLE iceberg_table EXECUTE remove_orphan_files(retention_threshold =&gt; &#39;7d&#39;)
6.å‡çº§è¡¨çš„ç‰ˆæœ¬å¦‚V1å‡çº§åˆ°V2
ALTER TABLE iceberg_table SET PROPERTIES format_version = 2;
7.V2è¡¨æ ¹æ®æ¡ä»¶è¿›è¡Œè¡Œçº§åˆ é™¤æ“ä½œ (V1è¡¨ä¸æ”¯æŒè¡Œçº§åˆ é™¤,åªæ”¯æŒåˆ†åŒºæ¡ä»¶åˆ é™¤)
delete from iceberg_table where ds=&#39;2022120102&#39; and eventid = &#39;event_1&#39;;
8.ä¿®æ”¹åˆ†åŒºä¹‹æ·»åŠ ä¸€ä¸ªåˆ†åŒºå­—æ®µ
ALTER TABLE iceberg_table SET PROPERTIES partitioning = ARRAY[&lt;existing partition columns&gt;, &#39;my_new_partition_column&#39;];
9.ä¿®æ”¹è¡¨å’Œå­—æ®µæ³¨é‡Š åœ¨Trinoä¿®æ”¹ååŒæ ·ä¼šåœ¨Hiveç”Ÿæ•ˆ
COMMENT ON TABLE iceberg_table IS &#39;Table comment&#39;;
COMMENT ON COLUMN iceberg_table.name IS &#39;Column comment&#39;;
10.TimeTravelæŸ¥è¯¢ ä¸´æ—¶æŸ¥è¯¢å†å²æŸä¸ªå¿«ç…§çš„æ•°æ®
SELECT * FROM iceberg.iceberg_db.iceberg_table FOR VERSION AS OF 8954597067493422955;
SELECT * FROM iceberg.iceberg_db.iceberg_table FOR TIMESTAMP AS OF TIMESTAMP &#39;2022-12-02 09:59:29.803 Europe/Vienna&#39;;
11.å›æ»šå½“å‰è¡¨çŠ¶æ€åˆ°æŸä¸ªå†å²å¿«ç…§çš„çŠ¶æ€
CALL iceberg.system.rollback_to_snapshot(&#39;iceberg_db&#39;, &#39;iceberg_table&#39;, 8954597067493422955);
12.æŸ¥çœ‹è¡¨çš„æ–‡ä»¶å’Œæ–‡ä»¶ä¿®æ”¹æ—¶é—´
select &quot;$path&quot;, &quot;$file_modified_time&quot; from iceberg_table;
13.æŸ¥è¯¢æ•°æ®
select * from iceberg_table limit 10;
select * from &quot;iceberg_table$data&quot; limit 10; [ç­‰ä»·äºä¸Šé¢çš„SQL]
14.æŸ¥çœ‹è¡¨é…ç½®å‚æ•°
select * from &quot;iceberg_table$properties&quot;;
15.æŸ¥çœ‹è¡¨å…ƒæ•°æ®æ›´æ”¹å†å²è®°å½•
select * from &quot;iceberg_table$history&quot;;
16.åˆ—å‡ºè¡¨æ¶‰åŠåˆ°çš„manifest fileåˆ—è¡¨
select * from &quot;iceberg_table$manifests&quot;;
17.åˆ—å‡ºè¡¨åœ¨å½“å‰å¿«ç…§(å½“å‰çŠ¶æ€)ä¸‹å¼•ç”¨çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶
select * from &quot;iceberg_table$files&quot;;
18.åˆ›å»ºTrinoç‰©åŒ–è§†å›¾ åªæ”¯æŒTrinoä¸­æŸ¥è¯¢
CREATE OR REPLACE MATERIALIZED VIEW iceberg_view COMMENT &#39;materializedView&#39; WITH ( format = &#39;ORC&#39;, partitioning = ARRAY[&#39;ds&#39;] ) as select appid,ds from iceberg_table;
CREATE MATERIALIZED VIEW IF NOT EXISTS iceberg_view COMMENT &#39;materializedView&#39; WITH ( format = &#39;ORC&#39;, partitioning = ARRAY[&#39;ds&#39;] ) as select appid,ds from iceberg_table;
REFRESH MATERIALIZED VIEW iceberg_view; [åº•å±‚è¡¨æ•°æ®å˜åŒ–å¯¼è‡´ç‰©åŒ–è§†å›¾ä¸åº•å±‚è¡¨æ•°æ®ä¸ä¸€è‡´æ—¶,ä½¿ç”¨è¯¥å‘½ä»¤æ›´æ–°ç‰©åŒ–è§†å›¾]
19.å¦‚æœæŸ¥è¯¢å¾ˆå¤æ‚å¹¶ä¸”åŒ…æ‹¬è¿æ¥å¤§å‹æ•°æ®é›†ï¼Œåˆ™åœ¨è¡¨ä¸Šè¿è¡ŒANALYZEå¯ä»¥é€šè¿‡æ”¶é›†æœ‰å…³æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯æ¥æé«˜æŸ¥è¯¢æ€§èƒ½
SET SESSION iceberg.experimental_extended_statistics_enabled = true;
ANALYZE iceberg_table;
ANALYZE iceberg_table WITH (columns = ARRAY[&#39;col_1&#39;, &#39;col_2&#39;]);
ALTER TABLE iceberg_table EXECUTE drop_extended_stats;  [å¦‚æœéœ€è¦é‡æ–°åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯,åˆ™å†é‡æ–°åˆ†æå‰å…ˆæ¸…é™¤ä¹‹å‰ç»Ÿè®¡çš„ä¿¡æ¯]
20.åˆ›å»ºè¡¨(æœ¬è´¨ä¹Ÿæ˜¯åˆ›å»ºHiveCatalogè¡¨,ä¸å»ºè®®åœ¨Trinoå»ºIcebergè¡¨,å› ä¸ºHiveå¼•æ“æ— æ³•æ”¯æŒ)
CREATE TABLE iceberg_oss_table (
    c1 integer,
    c2 date,
    c3 double
)
WITH (
    format = &#39;PARQUET&#39;,
    partitioning = ARRAY[&#39;c1&#39;, &#39;c2&#39;],
    location = &#39;oss://bucket-name/user/iceberg/warehouse/iceberg_oss_table&#39;
);</code></pre>
<h3 id="Icebergä¸Sparké›†æˆ"><a href="#Icebergä¸Sparké›†æˆ" class="headerlink" title="Icebergä¸Sparké›†æˆ"></a>Icebergä¸Sparké›†æˆ</h3><p>ä¸‹è½½iceberg-spark-runtime-3.3_2.12-1.0.0.jaråˆ°$SPARK_HOME/jarsè·¯å¾„<br>ç¼–è¾‘$SPARK_HOME/conf/spark-defaults.confæ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<pre><code class="conf">spark.sql.catalog.spark_catalog  org.apache.iceberg.spark.SparkSessionCatalog
spark.sql.catalog.spark_catalog.type  hive</code></pre>
<p>Sparkåˆ›å»ºçš„Icebergè¡¨æ‰“é€šHive</p>
<pre><code class="sql">-- Sparkåˆ›å»ºIcebergè¡¨
CREATE TABLE spark_catalog.default.qjj_iceberg_test (
    id bigint COMMENT &#39;unique id&#39;,
    data string
) USING iceberg
LOCATION &#39;oss://bucket-name/user/hive/warehouse/qjj_iceberg_test&#39;;
-- Hiveä¸­å…¼å®¹Sparkåˆ›å»ºçš„Icebergè¡¨éœ€è¦åšçš„æ“ä½œ
ALTER TABLE qjj_iceberg_test SET FILEFORMAT INPUTFORMAT &quot;org.apache.iceberg.mr.hive.HiveIcebergInputFormat&quot; OUTPUTFORMAT &quot;org.apache.iceberg.mr.hive.HiveIcebergOutputFormat&quot; SERDE &quot;org.apache.iceberg.mr.hive.HiveIcebergSerDe&quot;;
alter table qjj_iceberg_test set TBLPROPERTIES (&#39;storage_handler&#39;=&#39;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#39;);</code></pre>
<p>æ³¨: Hiveåˆ›å»ºçš„Icebergè¡¨å¯ä»¥ç›´æ¥è¢«Sparkè¯»å–</p>
<h2 id="Icebergè¡¨ç®¡ç†ç»´æŠ¤"><a href="#Icebergè¡¨ç®¡ç†ç»´æŠ¤" class="headerlink" title="Icebergè¡¨ç®¡ç†ç»´æŠ¤"></a>Icebergè¡¨ç®¡ç†ç»´æŠ¤</h2><p>æ•°æ®å®æ—¶å†™å…¥Icebergè¡¨ä¼šé¢‘ç¹å‘ç”ŸCommitæ“ä½œ,äº§ç”Ÿå¤§é‡å…ƒæ•°æ®æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶,æ–‡ä»¶æ•°è†¨èƒ€å’Œå°æ–‡ä»¶é—®é¢˜ä¼šä½¿å…¶æ€§èƒ½ä¸‹é™,ç”šè‡³å½±å“åº•å±‚å­˜å‚¨ç³»ç»Ÿç¨³å®šæ€§.ç›®å‰Icebergè¡¨å¹¶ä¸èƒ½åƒHudiä¸€æ ·è‡ªåŠ¨å¤„ç†å°æ–‡ä»¶é—®é¢˜,éœ€è¦ä¸€å®šçš„æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œ.<br>ä»¥ä¸‹æ˜¯å‘ç”Ÿ31æ¬¡commitå,Icebergè¡¨ç›®å½•æ ‘å½¢ç»“æ„.</p>
<pre><code class="tree">hadoop_iceberg_partitioned_table
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ dt=20221010
â”‚Â Â  â”‚Â Â  â””â”€â”€ 00000-0-hive_20221102105407_0605b24c-e823-4244-a994-83887ea7e430-job_1667357081446_0002-00001.parquet
â”‚Â Â  â”œâ”€â”€ dt=20221011
â”‚Â Â  â”‚Â Â  â””â”€â”€ 00000-0-hive_20221102105315_5bb17fc0-3092-4bed-8839-253f19117b6d-job_1667357081446_0001-00001.parquet
â”‚Â Â  â””â”€â”€ dt=20221104
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104104344_a66cc954-b33c-48df-812c-cc59d609ec59-job_1667529535736_0001-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104104714_7bc45bcf-b8dc-4730-b9b5-d0c92ae46d5d-job_1667529535736_0002-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104104805_4a490286-3499-43fb-affb-4317e07128d1-job_1667529535736_0003-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104104851_71127db1-1170-4a38-a3d4-83e296fd3330-job_1667529535736_0004-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104105901_1d66566e-af6c-4311-b123-86cfd18e0102-job_1667529535736_0005-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110033_e6e579d7-b08f-48b1-9277-b51b318dec7c-job_1667529535736_0006-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110100_345a4caa-bb75-4ea4-be5c-51a2420c428d-job_1667529535736_0007-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110124_bbb8626e-3d06-48a4-be6a-3ef061be4122-job_1667529535736_0008-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110152_13d0e1a5-6630-4dc2-ae24-ee104cbca3b5-job_1667529535736_0009-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110158_4283a83a-2662-4a89-8311-e8f89fe64603-job_1667529535736_0010-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110218_66253aad-58ca-4121-b454-8383e1ae7aae-job_1667529535736_0011-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110245_c041e352-dacd-4f5e-9fb4-ca321b4b3468-job_1667529535736_0012-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110311_29653ebe-6426-4163-8ace-7b1d305c9253-job_1667529535736_0013-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110336_35708806-e3a6-4746-851a-e8d306812810-job_1667529535736_0014-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110400_d1949e60-6123-49ff-8a85-0281651cf0b2-job_1667529535736_0015-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110425_e0cdc030-7d88-4b5f-8956-c95ffd71e698-job_1667529535736_0016-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110448_e144f00c-60b7-4935-a749-d3d88eba828a-job_1667529535736_0017-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110513_01b3285c-a3c8-490c-bc3c-5dbd696824e8-job_1667529535736_0018-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110538_bbe889dd-8615-4019-b6cc-636d1503dc8c-job_1667529535736_0019-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110602_09da4a19-c2ac-46af-af6c-5d97a3fbdcd9-job_1667529535736_0020-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110627_b1544cff-a0c2-4310-a06a-cd6103e40e9d-job_1667529535736_0021-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110651_a7e21f79-764d-4e62-8174-109dc4f1e7e2-job_1667529535736_0022-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110716_a657cb8b-45be-4484-9a21-bc2814e0c6b1-job_1667529535736_0023-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110742_f0e29e2e-4225-4e42-9699-524a19dacf44-job_1667529535736_0024-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110805_1827ea66-b863-4ecb-adc2-285470309490-job_1667529535736_0025-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110831_1019e38e-4845-4792-83fb-39822e497983-job_1667529535736_0026-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110919_4f1e3e96-1d37-40f3-aa2e-2a0139170381-job_1667529535736_0027-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-shmily_20221104110943_9ff35be2-cec0-4389-843e-395c7c6ec428-job_1667529535736_0028-00001.parquet
â”‚Â Â      â””â”€â”€ 00000-0-shmily_20221104111008_7a8ca8e3-d4c6-4aa1-81b6-c79d6ba7dd4f-job_1667529535736_0029-00001.parquet
â”œâ”€â”€ metadata
â”‚Â Â  â”œâ”€â”€ 03710058-d552-4dc1-b9cb-9340729e8f5e-m0.avro
â”‚Â Â  â”œâ”€â”€ 09fd33b8-c9ce-4f7c-b871-ca31f096e3b1-m0.avro
â”‚Â Â  â”œâ”€â”€ 12169e7b-13cb-4393-8158-1c9effe14e8f-m0.avro
â”‚Â Â  â”œâ”€â”€ 2e834cae-756b-4498-a82a-2418db4b1092-m0.avro
â”‚Â Â  â”œâ”€â”€ 3486a62e-1d74-49bd-bad3-c61187fac97f-m0.avro
â”‚Â Â  â”œâ”€â”€ 3a9351b4-388b-44d9-8243-4a11189d81b2-m0.avro
â”‚Â Â  â”œâ”€â”€ 3d0a560f-06f4-4402-a388-0b3cc7e25598-m0.avro
â”‚Â Â  â”œâ”€â”€ 40862af2-6d95-40b8-a979-2360ea3b7175-m0.avro
â”‚Â Â  â”œâ”€â”€ 44671db7-02ca-47c1-a229-c7f62d8aa12f-m0.avro
â”‚Â Â  â”œâ”€â”€ 551c586b-9c4d-4ca4-a0ef-d46c30fb01f8-m0.avro
â”‚Â Â  â”œâ”€â”€ 5baf0fec-3247-48f3-84f6-2f6402e866c7-m0.avro
â”‚Â Â  â”œâ”€â”€ 639416fc-47c0-452e-a1d9-f17864cf008f-m0.avro
â”‚Â Â  â”œâ”€â”€ 63ab2797-6a07-4886-9c27-43765bc31851-m0.avro
â”‚Â Â  â”œâ”€â”€ 74ca6f5e-4eab-45d9-b0b1-04ba48e53971-m0.avro
â”‚Â Â  â”œâ”€â”€ 8a4ce917-5986-4a95-9573-62103a116559-m0.avro
â”‚Â Â  â”œâ”€â”€ 90bcc77d-5516-4c3e-96c8-242713920b1b-m0.avro
â”‚Â Â  â”œâ”€â”€ 9f87073d-4cbc-46e9-b4dd-42fc28c86726-m0.avro
â”‚Â Â  â”œâ”€â”€ a4c74672-5ace-4a79-aca9-677926532794-m0.avro
â”‚Â Â  â”œâ”€â”€ b0e01ba5-bbe9-4ce4-ad9e-f07ab774a041-m0.avro
â”‚Â Â  â”œâ”€â”€ b1a2cd1f-e30a-4c45-9119-9ba0e185cc58-m0.avro
â”‚Â Â  â”œâ”€â”€ b209efb3-aab3-4bc2-a821-0557a0cda8d3-m0.avro
â”‚Â Â  â”œâ”€â”€ b7c5b752-49d4-4840-8990-fb4a84e0f71d-m0.avro
â”‚Â Â  â”œâ”€â”€ b9ba125d-bd76-483d-94f7-f6a9b664f633-m0.avro
â”‚Â Â  â”œâ”€â”€ bcc5bf7b-7f01-4969-9f4c-cc9c1c920029-m0.avro
â”‚Â Â  â”œâ”€â”€ d5b51efd-32b4-4948-9cc8-f2422919f1d7-m0.avro
â”‚Â Â  â”œâ”€â”€ d6492cb2-7012-4668-9af9-c25cbe4df95a-m0.avro
â”‚Â Â  â”œâ”€â”€ e511d02d-ecd8-4a3f-b8b7-45ad864026dc-m0.avro
â”‚Â Â  â”œâ”€â”€ e652600f-4167-4f59-92cc-45faf15b03b1-m0.avro
â”‚Â Â  â”œâ”€â”€ f0e6c6ca-51a7-42e6-b412-4036e27c7d98-m0.avro
â”‚Â Â  â”œâ”€â”€ f3646fc2-7e64-4395-8adc-cd6a75413d37-m0.avro
â”‚Â Â  â”œâ”€â”€ f91de7e0-2bf3-4804-bb28-64b61ebc588f-m0.avro
â”‚Â Â  â”œâ”€â”€ snap-1244418053907939374-1-44671db7-02ca-47c1-a229-c7f62d8aa12f.avro
â”‚Â Â  â”œâ”€â”€ snap-1477308230043616149-1-f91de7e0-2bf3-4804-bb28-64b61ebc588f.avro
â”‚Â Â  â”œâ”€â”€ snap-1490572932134542813-1-5baf0fec-3247-48f3-84f6-2f6402e866c7.avro
â”‚Â Â  â”œâ”€â”€ snap-1778869542790618047-1-12169e7b-13cb-4393-8158-1c9effe14e8f.avro
â”‚Â Â  â”œâ”€â”€ snap-2054318792294634903-1-f3646fc2-7e64-4395-8adc-cd6a75413d37.avro
â”‚Â Â  â”œâ”€â”€ snap-2520326235035414997-1-b7c5b752-49d4-4840-8990-fb4a84e0f71d.avro
â”‚Â Â  â”œâ”€â”€ snap-3185789235788477057-1-e652600f-4167-4f59-92cc-45faf15b03b1.avro
â”‚Â Â  â”œâ”€â”€ snap-3406584701390941146-1-b209efb3-aab3-4bc2-a821-0557a0cda8d3.avro
â”‚Â Â  â”œâ”€â”€ snap-3684994728472824032-1-9f87073d-4cbc-46e9-b4dd-42fc28c86726.avro
â”‚Â Â  â”œâ”€â”€ snap-3706799770416474623-1-a4c74672-5ace-4a79-aca9-677926532794.avro
â”‚Â Â  â”œâ”€â”€ snap-3951591399252751391-1-3a9351b4-388b-44d9-8243-4a11189d81b2.avro
â”‚Â Â  â”œâ”€â”€ snap-4081427338556096982-1-d5b51efd-32b4-4948-9cc8-f2422919f1d7.avro
â”‚Â Â  â”œâ”€â”€ snap-4367759472594176887-1-b0e01ba5-bbe9-4ce4-ad9e-f07ab774a041.avro
â”‚Â Â  â”œâ”€â”€ snap-4477640749996566080-1-63ab2797-6a07-4886-9c27-43765bc31851.avro
â”‚Â Â  â”œâ”€â”€ snap-4792262885242972970-1-551c586b-9c4d-4ca4-a0ef-d46c30fb01f8.avro
â”‚Â Â  â”œâ”€â”€ snap-501818490576080743-1-3486a62e-1d74-49bd-bad3-c61187fac97f.avro
â”‚Â Â  â”œâ”€â”€ snap-558299450529529123-1-bcc5bf7b-7f01-4969-9f4c-cc9c1c920029.avro
â”‚Â Â  â”œâ”€â”€ snap-6000755959745218957-1-09fd33b8-c9ce-4f7c-b871-ca31f096e3b1.avro
â”‚Â Â  â”œâ”€â”€ snap-6590633258547705279-1-639416fc-47c0-452e-a1d9-f17864cf008f.avro
â”‚Â Â  â”œâ”€â”€ snap-70006429373167712-1-d6492cb2-7012-4668-9af9-c25cbe4df95a.avro
â”‚Â Â  â”œâ”€â”€ snap-7258286604987289050-1-03710058-d552-4dc1-b9cb-9340729e8f5e.avro
â”‚Â Â  â”œâ”€â”€ snap-7353150060042609479-1-e511d02d-ecd8-4a3f-b8b7-45ad864026dc.avro
â”‚Â Â  â”œâ”€â”€ snap-7512257803790292671-1-b9ba125d-bd76-483d-94f7-f6a9b664f633.avro
â”‚Â Â  â”œâ”€â”€ snap-7520911403174383355-1-90bcc77d-5516-4c3e-96c8-242713920b1b.avro
â”‚Â Â  â”œâ”€â”€ snap-7612339408675772086-1-40862af2-6d95-40b8-a979-2360ea3b7175.avro
â”‚Â Â  â”œâ”€â”€ snap-7688152750730458585-1-f0e6c6ca-51a7-42e6-b412-4036e27c7d98.avro
â”‚Â Â  â”œâ”€â”€ snap-8654338094020315416-1-8a4ce917-5986-4a95-9573-62103a116559.avro
â”‚Â Â  â”œâ”€â”€ snap-8685114841540976719-1-b1a2cd1f-e30a-4c45-9119-9ba0e185cc58.avro
â”‚Â Â  â”œâ”€â”€ snap-8693851636236625016-1-2e834cae-756b-4498-a82a-2418db4b1092.avro
â”‚Â Â  â”œâ”€â”€ snap-8855760427151465849-1-3d0a560f-06f4-4402-a388-0b3cc7e25598.avro
â”‚Â Â  â”œâ”€â”€ snap-9102081850556452524-1-74ca6f5e-4eab-45d9-b0b1-04ba48e53971.avro
â”‚Â Â  â”œâ”€â”€ v1.metadata.json
â”‚Â Â  â”œâ”€â”€ v2.metadata.json
â”‚Â Â  â”œâ”€â”€ v3.metadata.json
â”‚Â Â  â”œâ”€â”€ v4.metadata.json
â”‚Â Â  â”œâ”€â”€ v5.metadata.json
â”‚Â Â  â”œâ”€â”€ v6.metadata.json
â”‚Â Â  â”œâ”€â”€ v7.metadata.json
â”‚Â Â  â”œâ”€â”€ v8.metadata.json
â”‚Â Â  â”œâ”€â”€ v9.metadata.json
â”‚Â Â  â”œâ”€â”€ v10.metadata.json
â”‚Â Â  â”œâ”€â”€ v11.metadata.json
â”‚Â Â  â”œâ”€â”€ v12.metadata.json
â”‚Â Â  â”œâ”€â”€ v13.metadata.json
â”‚Â Â  â”œâ”€â”€ v14.metadata.json
â”‚Â Â  â”œâ”€â”€ v15.metadata.json
â”‚Â Â  â”œâ”€â”€ v16.metadata.json
â”‚Â Â  â”œâ”€â”€ v17.metadata.json
â”‚Â Â  â”œâ”€â”€ v18.metadata.json
â”‚Â Â  â”œâ”€â”€ v19.metadata.json
â”‚Â Â  â”œâ”€â”€ v20.metadata.json
â”‚Â Â  â”œâ”€â”€ v21.metadata.json
â”‚Â Â  â”œâ”€â”€ v22.metadata.json
â”‚Â Â  â”œâ”€â”€ v23.metadata.json
â”‚Â Â  â”œâ”€â”€ v24.metadata.json
â”‚Â Â  â”œâ”€â”€ v25.metadata.json
â”‚Â Â  â”œâ”€â”€ v26.metadata.json
â”‚Â Â  â”œâ”€â”€ v27.metadata.json
â”‚Â Â  â”œâ”€â”€ v28.metadata.json
â”‚Â Â  â”œâ”€â”€ v29.metadata.json
â”‚Â Â  â”œâ”€â”€ v30.metadata.json
â”‚Â Â  â”œâ”€â”€ v31.metadata.json
â”‚Â Â  â”œâ”€â”€ v32.metadata.json
â”‚Â Â  â””â”€â”€ version-hint.text
â””â”€â”€ temp</code></pre>
<p>å…¶ä¸­æœ‰32ä¸ªMetadataFileæ–‡ä»¶(metadata.json),31ä¸ªManifestListæ–‡ä»¶(snap-*.avro),31ä¸ªManifestFileæ–‡ä»¶(xx-m0.avro)ä»¥åŠ31ä¸ªDataFile(xx.parquet)æ–‡ä»¶.<br>næ¬¡commitä¼šå¸¦æ¥3n+1ä¸ªæ–‡ä»¶è½ç›˜.<br>æ‰§è¡Œæ¸…ç†(åˆå¹¶æ•°æ®æ–‡ä»¶-&gt;æ¸…ç†è¿‡æœŸå¿«ç…§-&gt;é‡å†™ManifestFile-&gt;æ¸…ç†å­¤ç«‹æ–‡ä»¶)å,å°æ–‡ä»¶æ•°é‡å¤šçš„é—®é¢˜ä¼šæœ‰æ˜æ˜¾æ”¹å–„,ç»“æœå¦‚ä¸‹:</p>
<pre><code class="tree">hadoop_iceberg_partitioned_table_after
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ dt=20221010
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-0-hive_20221102105407_0605b24c-e823-4244-a994-83887ea7e430-job_1667357081446_0002-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-1-5ea18300-180b-465d-8310-bbbf422e15b8-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-1-78fcc067-f967-465f-be58-f5beff8561dd-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-2-be5c1e4a-254f-4503-9ff5-f8817a9e92f7-00001.parquet
â”‚Â Â  â”‚Â Â  â””â”€â”€ 00000-613-8bdfbded-0300-425a-8201-031920536100-00001.parquet
â”‚Â Â  â”œâ”€â”€ dt=20221011
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-0-d75b9b2f-4794-42e2-94fe-f6ae22ccd7d9-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-0-hive_20221102105315_5bb17fc0-3092-4bed-8839-253f19117b6d-job_1667357081446_0001-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-2-1402730f-cc62-4daf-a47e-a8aecaa545c8-00001.parquet
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00000-2-73f4cb74-1ab1-494d-ba4d-242b070bb82d-00001.parquet
â”‚Â Â  â”‚Â Â  â””â”€â”€ 00000-611-6edbc04e-0919-4ae4-be30-89a8b91478e6-00001.parquet
â”‚Â Â  â””â”€â”€ dt=20221104
â”‚Â Â      â”œâ”€â”€ 00000-0-11b9e51d-1ebd-496c-ae07-9e480c92c35e-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-274072c6-cefa-4395-ab31-016eacd19f08-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-0-ad26a63a-9b36-4c7d-9cb9-109aafae96fc-00001.parquet
â”‚Â Â      â”œâ”€â”€ 00000-1-bd95039f-65c4-4b19-938e-185d615e3e0d-00001.parquet
â”‚Â Â      â””â”€â”€ 00000-612-73dd262d-7377-42f7-87e8-024447dc6fd6-00001.parquet
â”œâ”€â”€ metadata
â”‚Â Â  â”œâ”€â”€ 6d24ddd9-be10-42f3-a5d6-4551ee5a8bf0-m0.avro
â”‚Â Â  â”œâ”€â”€ 79077b45-29e8-4d19-89a0-aef243b6a4ca-m0.avro
â”‚Â Â  â”œâ”€â”€ 79077b45-29e8-4d19-89a0-aef243b6a4ca-m1.avro
â”‚Â Â  â”œâ”€â”€ 7f9cc85d-0de4-4c4c-bde7-54d4f4f78447-m0.avro
â”‚Â Â  â”œâ”€â”€ ae99e2ab-fcc5-44b0-bd94-f2d73eab22f3-m0.avro
â”‚Â Â  â”œâ”€â”€ ae99e2ab-fcc5-44b0-bd94-f2d73eab22f3-m1.avro
â”‚Â Â  â”œâ”€â”€ d2eeb7b2-9607-4c5b-bdc5-6cfe2c81ed94-m0.avro
â”‚Â Â  â”œâ”€â”€ e52f34b0-ff45-4207-87a0-95b1897da11a-m0.avro
â”‚Â Â  â”œâ”€â”€ e52f34b0-ff45-4207-87a0-95b1897da11a-m1.avro
â”‚Â Â  â”œâ”€â”€ e715d26c-152c-4ff3-9533-7860d920503d-m0.avro
â”‚Â Â  â”œâ”€â”€ e715d26c-152c-4ff3-9533-7860d920503d-m1.avro
â”‚Â Â  â”œâ”€â”€ snap-2296367325872747730-1-e715d26c-152c-4ff3-9533-7860d920503d.avro
â”‚Â Â  â”œâ”€â”€ snap-3114464783889165727-1-6d24ddd9-be10-42f3-a5d6-4551ee5a8bf0.avro
â”‚Â Â  â”œâ”€â”€ snap-4397206702551297792-1-ae99e2ab-fcc5-44b0-bd94-f2d73eab22f3.avro
â”‚Â Â  â”œâ”€â”€ snap-5015314203544980905-1-7f9cc85d-0de4-4c4c-bde7-54d4f4f78447.avro
â”‚Â Â  â”œâ”€â”€ snap-761586103173871579-1-79077b45-29e8-4d19-89a0-aef243b6a4ca.avro
â”‚Â Â  â”œâ”€â”€ snap-8390029841836840556-1-d2eeb7b2-9607-4c5b-bdc5-6cfe2c81ed94.avro
â”‚Â Â  â”œâ”€â”€ snap-8895954507409072148-1-e52f34b0-ff45-4207-87a0-95b1897da11a.avro
â”‚Â Â  â”œâ”€â”€ v38.metadata.json
â”‚Â Â  â”œâ”€â”€ v39.metadata.json
â”‚Â Â  â”œâ”€â”€ v40.metadata.json
â”‚Â Â  â”œâ”€â”€ v41.metadata.json
â”‚Â Â  â”œâ”€â”€ v42.metadata.json
â”‚Â Â  â”œâ”€â”€ v43.metadata.json
â”‚Â Â  â””â”€â”€ version-hint.text
â””â”€â”€ temp</code></pre>
<h3 id="metadataæ•°æ§åˆ¶"><a href="#metadataæ•°æ§åˆ¶" class="headerlink" title="metadataæ•°æ§åˆ¶"></a>metadataæ•°æ§åˆ¶</h3><p>åœ¨Icebergä¸­,æ¯æ¬¡è§¦å‘äº‹åŠ¡æäº¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªmetadata.json,åº”å½“é¿å…metadataæ–‡ä»¶æ— é™å¢é•¿,å¯ä»¥åœ¨å»ºè¡¨æ—¶æŒ‡å®šå¦‚ä¸‹å‚æ•°:</p>
<pre><code class="conf">&#39;write.metadata.delete-after-commit.enabled&#39;=&#39;true&#39; # å‘ç”Ÿcommitå,æ˜¯å¦åˆ é™¤æ¯”è¾ƒæ—§çš„metadataæ–‡ä»¶
&#39;write.metadata.previous-versions-max&#39;=&#39;9&#39; # ä¿ç•™çš„æœ€å¤§å†å²metadataæ–‡ä»¶æ•°é‡,è¶…è¿‡è¯¥å†å²ç‰ˆæœ¬æ•°é‡çš„è€çš„metadataæ–‡ä»¶ä¼šè¢«åˆ é™¤</code></pre>
<p>è¿™æ ·å¯ä»¥è‡ªåŠ¨æ§åˆ¶MetadataFileæ–‡ä»¶æ•°ä¸º9ä¸ª.</p>
<h3 id="æ¸…ç†è¿‡æœŸsnapshot"><a href="#æ¸…ç†è¿‡æœŸsnapshot" class="headerlink" title="æ¸…ç†è¿‡æœŸsnapshot"></a>æ¸…ç†è¿‡æœŸsnapshot</h3><p>æ¸…ç†Icebergè¡¨è¿‡æœŸå¿«ç…§çš„Demo<br>Flinkå®ç°:<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Iceberg/src/main/scala/top/shmily_qjj/iceberg/table/maintenance/ClearExpiredSnapshots.scala"><strong>ClearExpiredSnapshots</strong></a><br>Sparkå®ç°:<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Iceberg/src/main/scala/top/shmily_qjj/iceberg/table/maintenance/SparkIcebergTableMaintenance.scala"><strong>SparkIcebergTableMaintenance$expireSnapshots</strong></a></p>
<h3 id="æ•°æ®æ–‡ä»¶é‡å†™"><a href="#æ•°æ®æ–‡ä»¶é‡å†™" class="headerlink" title="æ•°æ®æ–‡ä»¶é‡å†™"></a>æ•°æ®æ–‡ä»¶é‡å†™</h3><p>æµå¼æ•°æ®å†™å…¥å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡å°çš„æ•°æ®æ–‡ä»¶,Icebergæä¾›äº†rewriteDataFiles(Compaction)æ“ä½œ,å¯ä»¥å®šæœŸåˆå¹¶å°æ–‡ä»¶,æé«˜æŸ¥è¯¢æ€§èƒ½.<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Iceberg/src/main/scala/top/shmily_qjj/iceberg/table/maintenance/SparkIcebergTableMaintenance.scala"><strong>SparkIcebergTableMaintenance$compactDataFiles</strong></a></p>
<h3 id="å…ƒæ•°æ®æ–‡ä»¶é‡å†™"><a href="#å…ƒæ•°æ®æ–‡ä»¶é‡å†™" class="headerlink" title="å…ƒæ•°æ®æ–‡ä»¶é‡å†™"></a>å…ƒæ•°æ®æ–‡ä»¶é‡å†™</h3><p>æ¯æ¬¡Commitéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªmetadataæ–‡ä»¶,éšç€æ—¶é—´çš„æ¨ç§»,å®æ—¶ä»»åŠ¡å†™å…¥çš„MetadataFileæ•°è¶Šæ¥è¶Šå¤š,åšåˆå¹¶å¯ä»¥é™ä½æ–‡ä»¶æ•°,æå‡æŸ¥è¯¢æ•ˆç‡.<br><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Iceberg/src/main/scala/top/shmily_qjj/iceberg/table/maintenance/SparkIcebergTableMaintenance.scala"><strong>SparkIcebergTableMaintenance$rewriteManifests</strong></a></p>
<h3 id="æ¸…ç†å­¤ç«‹æ–‡ä»¶"><a href="#æ¸…ç†å­¤ç«‹æ–‡ä»¶" class="headerlink" title="æ¸…ç†å­¤ç«‹æ–‡ä»¶"></a>æ¸…ç†å­¤ç«‹æ–‡ä»¶</h3><p><a target="_blank" rel="noopener" href="https://github.com/Shmilyqjj/Shmily/blob/master/Iceberg/src/main/scala/top/shmily_qjj/iceberg/table/maintenance/SparkIcebergTableMaintenance.scala"><strong>SparkIcebergTableMaintenance$removeOrphanFiles</strong></a></p>
<h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><h3 id="ManifestFileæ–‡ä»¶ä¸¢å¤±"><a href="#ManifestFileæ–‡ä»¶ä¸¢å¤±" class="headerlink" title="ManifestFileæ–‡ä»¶ä¸¢å¤±"></a>ManifestFileæ–‡ä»¶ä¸¢å¤±</h3><pre><code class="err">2023-01-30 09:36:57,558 WARN  org.apache.flink.runtime.taskmanager.Task [] - IcebergFilesCommitter -&gt; Sink: IcebergSink (1
/1)#0 (2125b52f518a53194e79e9f5d86dbb78) switched from RUNNING to FAILED with failure cause: org.apache.iceberg.exceptions.NotFoundException:
 Failed to open input stream for file: oss://xxxxx/user/hive/warehouse/iceberg_db/xxxxx/metadata/f86794c3-750d-4def-ad2d-b726c4c210ad-m0.avro
        at org.apache.iceberg.hadoop.HadoopInputFile.newStream(HadoopInputFile.java:183)
        at org.apache.iceberg.avro.AvroIterable.newFileReader(AvroIterable.java:100)
        at org.apache.iceberg.avro.AvroIterable.getMetadata(AvroIterable.java:65)
        at org.apache.iceberg.ManifestReader.&lt;init&gt;(ManifestReader.java:115)
        at org.apache.iceberg.ManifestFiles.read(ManifestFiles.java:91)
        at org.apache.iceberg.SnapshotProducer.newManifestReader(SnapshotProducer.java:448)
        at org.apache.iceberg.MergingSnapshotProducer$DataFileMergeManager.newManifestReader(MergingSnapshotProducer.java:1005)
        at org.apache.iceberg.ManifestMergeManager.createManifest(ManifestMergeManager.java:175)
        at org.apache.iceberg.ManifestMergeManager.lambda$mergeGroup$1(ManifestMergeManager.java:156)
        at org.apache.iceberg.util.Tasks$Builder.runTaskWithRetry(Tasks.java:402)
        at org.apache.iceberg.util.Tasks$Builder.access$300(Tasks.java:68)
        at org.apache.iceberg.util.Tasks$Builder$1.run(Tasks.java:308)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
Caused by: java.io.FileNotFoundException: ErrorCode : 25002 , ErrorMsg: File not found.  [RequestId]: ...</code></pre>
<p>åŸå› : å¯èƒ½åˆå¹¶ä»»åŠ¡å¼‚å¸¸å¯¼è‡´<br>è§£å†³:</p>
<pre><code class="java">// å°†ä¸¢å¤±ManifestFileæ–‡ä»¶ä»å…ƒæ•°æ®ä¸­ç§»é™¤,ä»¥è§£å†³è¡¨ä¸å¯ç”¨çš„é—®é¢˜
        String lostManifestFilePath = &quot;xxxxx&quot;
        Table table = getTable(dbName, tabName);
        Snapshot snapshot = table.currentSnapshot();
        List&lt;ManifestFile&gt; manifestFiles = snapshot.allManifests(table.io());
        List&lt;ManifestFile&gt; manifestFileDeletes = new ArrayList&lt;&gt;();
        for (ManifestFile manifestFile : manifestFiles) &#123;
            String path = manifestFile.path();
            if (path.equals(lostManifestFilePath)) &#123;
                manifestFileDeletes.add(manifestFile);
                break;
            &#125;
        &#125;
        if (manifestFileDeletes.isEmpty()) &#123;
            throw new Exception(StringUtils.format(&quot;Manifest File:%s not in metadata&quot;,lostManifestFilePath));
        &#125;
        RewriteManifests rewriteManifests = table.rewriteManifests();
        for (ManifestFile manifestFile : manifestFileDeletes) &#123;
            rewriteManifests.deleteManifest(manifestFile);
        &#125;
        rewriteManifests.commit();
// ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½æŠ›å‡ºorg.apache.iceberg.exceptions.ValidationException:Replaced and created manifests must have the same number of active files: 0 (new), 5567 (old)
// ä¿®æ”¹iceberg-coreä½äºcore/src/main/java/org/apache/iceberg/BaseRewriteManifests.java activeFilesCountæ–¹æ³•æ³¨é‡Šæ‰å¦‚ä¸‹ä¸¤è¡Œ
//      activeFilesCount += manifest.addedFilesCount();
//      activeFilesCount += manifest.existingFilesCount();</code></pre>
<h3 id="Flinkå†™å…¥Icebergæ— æ³•æ‰¾åˆ°avroæ–‡ä»¶-å¯¼è‡´ä»»åŠ¡æŠ¥é”™æ— æ³•å†™å…¥"><a href="#Flinkå†™å…¥Icebergæ— æ³•æ‰¾åˆ°avroæ–‡ä»¶-å¯¼è‡´ä»»åŠ¡æŠ¥é”™æ— æ³•å†™å…¥" class="headerlink" title="Flinkå†™å…¥Icebergæ— æ³•æ‰¾åˆ°avroæ–‡ä»¶,å¯¼è‡´ä»»åŠ¡æŠ¥é”™æ— æ³•å†™å…¥"></a>Flinkå†™å…¥Icebergæ— æ³•æ‰¾åˆ°avroæ–‡ä»¶,å¯¼è‡´ä»»åŠ¡æŠ¥é”™æ— æ³•å†™å…¥</h3><pre><code class="error">org.apache.iceberg.exceptions.NotFoundException: Failed to open input stream for file: oss://bucket_name/user/hive/warehouse/iceberg_db/user_experience_report/metadata/32759abff25a1366837ed3d146e27d51-55f7b63bf1c8c02b88d8659b98477e64-00000-2-71-00037.avro
    at org.apache.iceberg.hadoop.HadoopInputFile.newStream(HadoopInputFile.java:183)
    at org.apache.iceberg.avro.AvroIterable.newFileReader(AvroIterable.java:100)
    at org.apache.iceberg.avro.AvroIterable.getMetadata(AvroIterable.java:65)
    at org.apache.iceberg.ManifestReader.&lt;init&gt;(ManifestReader.java:115)
    at org.apache.iceberg.ManifestFiles.read(ManifestFiles.java:91)
    at org.apache.iceberg.ManifestFiles.read(ManifestFiles.java:72)
    at org.apache.iceberg.flink.sink.FlinkManifestUtil.readDataFiles(FlinkManifestUtil.java:58)
    at org.apache.iceberg.flink.sink.FlinkManifestUtil.readCompletedFiles(FlinkManifestUtil.java:113)
    at org.apache.iceberg.flink.sink.IcebergFilesCommitter.commitUpToCheckpoint(IcebergFilesCommitter.java:244)
    at org.apache.iceberg.flink.sink.IcebergFilesCommitter.initializeState(IcebergFilesCommitter.java:184)
    at org.apache.flink.streaming.api.operators.StreamOperatorStateHandler.initializeOperatorState(StreamOperatorStateHandler.java:119)
    at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:286)
    at org.apache.flink.streaming.runtime.tasks.RegularOperatorChain.initializeStateAndOpenOperators(RegularOperatorChain.java:109)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreGates(StreamTask.java:711)
    at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.call(StreamTaskActionExecutor.java:55)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreInternal(StreamTask.java:687)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:654)
    at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:958)
    at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:927)
    at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:766)
    at org.apache.flink.runtime.taskmanager.Task.run(Task.java:575)
    at java.lang.Thread.run(Thread.java:748)
  ......</code></pre>
<p>å¯èƒ½åŸå› : æ­¤æ–‡ä»¶ä¸æ˜¯MainfestListæ–‡ä»¶ä¹Ÿä¸æ˜¯ManifestFileæ–‡ä»¶,è€Œæ˜¯Flinkå†™å…¥Icebergæ—¶ä¸€ç§ä¸­é—´çŠ¶æ€çš„æ–‡ä»¶,å¯èƒ½åŸå› æ˜¯checkpointè¶…æ—¶æˆ–æ—¶é—´è¿‡é•¿,ä½†è¯¥å¼‚å¸¸ä¸åˆå¹¶å’Œæ¸…ç†ä»»åŠ¡æ— å…³<br>è§£å†³: </p>
<pre><code>hdfs dfs -ls -r -t oss://bucket_name/user/hive/warehouse/iceberg_db/user_experience_report/metadata/ | grep avro | grep -v snap | grep -v m0 | grep -v m1 | grep -v m2 | grep -v m3
æ‰¾åˆ°æœ€æ–°avro æ‹·è´å¹¶é‡å‘½åä¸ºç¼ºå¤±çš„avro åŒæ—¶ä¼˜åŒ–checkpointç¨³å®šæ€§</code></pre>
<h3 id="HiveCatalogä¸‹é”è¡¨é€ æˆæäº¤commitå¤±è´¥"><a href="#HiveCatalogä¸‹é”è¡¨é€ æˆæäº¤commitå¤±è´¥" class="headerlink" title="HiveCatalogä¸‹é”è¡¨é€ æˆæäº¤commitå¤±è´¥"></a>HiveCatalogä¸‹é”è¡¨é€ æˆæäº¤commitå¤±è´¥</h3><pre><code class="error">23/05/14 03:32:34 INFO ApplicationMaster: Final app status: FAILED, exitCode: 15, (reason: User class threw exception: org.apache.iceberg.exceptions.CommitFailedException: Timed out after 183898 ms waiting for lock on iceberg_db.user_experience_report_user_details</code></pre>
<p>è§£å†³ï¼šåˆ°Hiveå…ƒæ•°æ®åº“select * from metastore.hive_locks; DELETE FROM metastore.hive_locks WHERE HL_DB=â€™iceberg_dbâ€™ AND HL_TABLE=â€™user_experience_report_user_detailsâ€™;å†é‡è·‘icebergä»»åŠ¡å³å¯</p>
<h2 id="å¯¹æ¯”Hudiå’ŒDeltaLake"><a href="#å¯¹æ¯”Hudiå’ŒDeltaLake" class="headerlink" title="å¯¹æ¯”Hudiå’ŒDeltaLake"></a>å¯¹æ¯”Hudiå’ŒDeltaLake</h2><table>
<thead>
<tr>
<th>å¯¹æ¯”ç»´åº¦\æŠ€æœ¯</th>
<th>Iceberg</th>
<th>Hudi</th>
<th>DeltaLake</th>
</tr>
</thead>
<tbody><tr>
<td>æ•°æ®ç®¡ç†</td>
<td>é€šè¿‡metadataæ–‡ä»¶ç®¡ç†</td>
<td>é€šè¿‡metadataæ–‡ä»¶ç®¡ç†</td>
<td>é€šè¿‡metadataæ–‡ä»¶ç®¡ç†</td>
</tr>
<tr>
<td>ä½¿ç”¨åœºæ™¯</td>
<td>æµæ‰¹ä¸€ä½“,é«˜æ€§èƒ½åˆ†æä¸å¯é æ•°æ®ç®¡ç†</td>
<td>æµæ‰¹ä¸€ä½“,Upsertåœºæ™¯</td>
<td>æµæ‰¹ä¸€ä½“,èåˆSparkç”Ÿæ€</td>
</tr>
<tr>
<td>ACID</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>ACIDéš”ç¦»çº§åˆ«</td>
<td>Write Serialization(å†™ä¸²è¡Œæ‰§è¡Œ)</td>
<td>Snapshot Isolation(å†™æ•°æ®è‹¥æ— äº¤é›†åˆ™å¹¶å‘å†™,å¦åˆ™ä¸²è¡Œ)</td>
<td>Serialization(è¯»å†™éƒ½å¿…é¡»ä¸²è¡Œ)/Write Serialization/Snapshot Isolation</td>
</tr>
<tr>
<td>Schemaæ¼”åŒ–</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>æ•°æ®æ“ä½œ</td>
<td>æ”¯æŒUpdate/Delete</td>
<td>æ”¯æŒUpsert/Delete</td>
<td>æ”¯æŒUpdate/Delete/Merge</td>
</tr>
<tr>
<td>æµå¼è¯»</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>æµå¼å†™</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>å¹¶å‘æ§åˆ¶</td>
<td>ä¹è§‚</td>
<td>ä¹è§‚</td>
<td>ä¹è§‚</td>
</tr>
<tr>
<td>æ–‡ä»¶æ¸…ç†</td>
<td>æ‰‹åŠ¨</td>
<td>è‡ªåŠ¨</td>
<td>æ‰‹åŠ¨</td>
</tr>
<tr>
<td>Compaction</td>
<td>æ‰‹åŠ¨</td>
<td>è‡ªåŠ¨</td>
<td>æ‰‹åŠ¨</td>
</tr>
<tr>
<td>å¤–éƒ¨ä¾èµ–</td>
<td>å®Œå…¨è§£è€¦</td>
<td>ä¾èµ–Spark</td>
<td>ä¾èµ–Spark</td>
</tr>
<tr>
<td>CopyOnWrite</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>MergeOnRead</td>
<td>v2è¡¨æ”¯æŒ,v1è¡¨ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>å­—æ®µåŠ å¯†</td>
<td>v3è¡¨è®¡åˆ’æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
</tbody></table>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="https://iceberg.apache.org/docs/latest">Apache Iceberg</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/429898023">Icebergæ¦‚è¿°</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1936522">æ·±åº¦å¯¹æ¯” Deltaã€Iceberg å’Œ Hudi ä¸‰å¤§å¼€æºæ•°æ®æ¹–æ–¹æ¡ˆ</a></p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">èµ<div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/custom/donate/aliPayQR.jpg"></li>
                <li class="wechat-code"><img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/custom/donate/weChatQR.png"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/3d59c888/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/CategoryImages/technology/tech05.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/CategoryImages/technology/tech05.jpg">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                Hiveåˆ—çº§è¡€ç¼˜ä¸å…ƒæ•°æ®æ”¶é›†</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/39a9ed67/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/Linux/DNS/DNS-cover.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/BlogImages/Linux/DNS/DNS-cover.jpg">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                Linux BindæœåŠ¡é…ç½®DNSè§£æ</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "zUyVEaHo59RUUwiPTChPEeBj-gzGzoHsz",
        appKey: "xIEyTcrkTuJLz6ewPbpTj8mz",
        path: window.location.pathname,
        placeholder: "ç¼˜åˆ†ä½¿æˆ‘ä»¬ç›¸é‡ï¼ç•™ä¸‹è¶³è¿¹å§..."
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <a href="shmily-qjj.top" class="profile gravatar"><img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/custom/avatar.jpg" itemprop="image" alt="ä½³å¢ƒ" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="shmily-qjj.top" itemprop="url" rel="author">ä½³å¢ƒ</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i>ä½ è‡ªä»¥ä¸ºçš„æé™,åªæ˜¯åˆ«äººçš„èµ·ç‚¹</p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="è¯·è¾“å…¥å…³é”®è¯..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            // PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 ä½³å¢ƒShmily<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://blog-images-1257889704.cos.ap-chengdu.myqcloud.com/Resources/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2020</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hexo</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> ä½³å¢ƒShmily</a>  <!-- &<a href="shmily-qjj.top" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a> -->
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- ä¸è’œå­ ç½‘é¡µè®¡æ•°å™¨ -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "http://pyp1a3dme.bkt.clouddn.com/","name":"blog-my_heart_will_go_on.mp4,blog-big_fish.mp4,blog_sakura.mp4,videoblog-metro.mp4,videoblog-xxdsx.mp4","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "http://pyp1a3dme.bkt.clouddn.com/","name":"blog-my_heart_will_go_on.mp4,blog-big_fish.mp4,blog_sakura.mp4,videoblog-metro.mp4,videoblog-xxdsx.mp4","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //æœ‰å›¾çš„æƒ…å†µ
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // æ”¾ç½®ç›®å½•çš„å®¹å™¨
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // æ­£æ–‡å†…å®¹æ‰€åœ¨
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // éœ€è¦ç´¢å¼•çš„æ ‡é¢˜çº§åˆ«
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // æ”¾ç½®ç›®å½•çš„å®¹å™¨
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // æ­£æ–‡å†…å®¹æ‰€åœ¨
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // éœ€è¦ç´¢å¼•çš„æ ‡é¢˜çº§åˆ«
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://cdn.jsdelivr.net/gh/Shmilyqjj/Shmily-Web@master/cdn_sources/img/custom/avatar.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">ä½³å¢ƒShmily</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="https://github.com/Shmilyqjj" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="http://music.163.com/artist?id=13610347&userid=318926152" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="https://wpa.qq.com/msgrd?v=3&uin=710552907&site=qq&menu=yes" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            é¦–é¡µ
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            å½’æ¡£
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/%E6%8A%80%E6%9C%AF/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  æŠ€æœ¯
                </a>
              </li>
            
              <li>
                <a href="/categories/%E7%94%9F%E6%B4%BB/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  ç”Ÿæ´»
                </a>
              </li>
            
              <li>
                <a href="/categories/%E9%9F%B3%E4%B9%90/">
                  <i class="fa fa-music" aria-hidden="true"></i>
                  éŸ³ä¹
                </a>
              </li>
            
              <li>
                <a href="/categories/%E9%9A%8F%E6%83%B3/">
                  <i class="fa fa-commenting-o" aria-hidden="true"></i>
                  éšæƒ³
                </a>
              </li>
            
              <li>
                <a href="/categories/%E5%85%B6%E4%BB%96/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  å…¶ä»–
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            æ¸…å•
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  çœ‹å‰§
                </a>
              </li>
            
              <li>
                <a href="/tags/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  ä¹¦å•
                </a>
              </li>
            
              <li>
                <a href="/music/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  æ­Œå•
                </a>
              </li>
            
              <li>
                <a href="/album/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  ç›¸å†Œ
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            ç•™è¨€æ¿
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            åšå‹åœˆ
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/donate/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
            èµèµ
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            å…³äº
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  æˆ‘ï¼Ÿ
                </a>
              </li>
            
              <li>
                <a target="_blank" rel="noopener" href="https://tech.shmily-qjj.top/">
                  <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                  æŠ€æœ¯
                </a>
              </li>
            
              <li>
                <a href="/lab/">
                  <i class="fa fa-cogs" aria-hidden="true"></i>
                  Lab
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/client/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
            å®¢æˆ·ç«¯
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/atom.xml">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
            RSS
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2020 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<div class="aplayer"

    data-id="2368663800"

    data-server="netease"

    data-type="playlist"

    data-fixed="true"

    data-autoplay="false"

    data-loop="all"

    data-order="random"

    data-preload="auto"

    data-volume="0.7"

    data-mutex="true"

    data-mini="true"

</div>
<script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"relative","left":"30px","width":150,"height":256},"mobile":{"show":false},"log":false,"tagMode":false});</script></body>
</html>